<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syntaxy</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--surface:#161b22;--surface2:#1c2333;--border:#30363d;
  --text:#c9d1d9;--dim:#8b949e;--accent:#58a6ff;--accent2:#3fb950;
  --danger:#f85149;--grad:linear-gradient(135deg,#58a6ff,#3fb950);
  --login-bg:url('https://images.unsplash.com/photo-1722583881373-a633de0d7f98?q=80&w=1469&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
}
html,body{height:100%;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);font-size:14px;overflow:hidden;user-select:none}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
#layout{display:grid;grid-template-columns:68px var(--sidebar-w,240px) auto 1fr;height:100vh}

/* ‚îÄ‚îÄ‚îÄ RAIL ‚îÄ‚îÄ‚îÄ */
#server-rail{background:#0a0d11;display:flex;flex-direction:column;align-items:center;padding:10px 0;gap:8px;border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.rail-icon[draggable="true"]{cursor:grab}.rail-icon[draggable="true"]:active{cursor:grabbing}
#server-rail::-webkit-scrollbar{width:4px}
#server-rail::-webkit-scrollbar-track{background:transparent}
#server-rail::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
#server-rail::-webkit-scrollbar-thumb:hover{background:var(--dim)}
.rail-icon{width:46px;height:46px;min-width:46px;min-height:46px;flex-shrink:0;border-radius:12px;background:var(--surface2);border:2px solid transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:21px;transition:border-color .18s,transform .15s;position:relative;overflow:hidden}
.rail-icon:hover{border-color:var(--accent);transform:scale(1.06)}
.rail-icon.active{border-color:var(--accent);border-radius:16px}
.rail-icon img{width:100%;height:100%;object-fit:cover}
.rail-divider{width:28px;height:2px;min-height:2px;flex-shrink:0;background:var(--border);border-radius:1px;margin:2px 0}
.rail-add{color:var(--dim);font-size:24px}

/* Icon images */
.icon-img{width:18px;height:18px;opacity:.7;transition:opacity .15s}
.sb-btn:hover .icon-img,.hd-btn:hover .icon-img{opacity:1}
.icon-img.invert{filter:invert(1)}
/* Server tooltip */
.rail-tooltip{position:fixed;background:var(--surface);color:var(--text);padding:8px 12px;border-radius:6px;font-size:13px;font-weight:600;white-space:nowrap;pointer-events:none;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid var(--border);opacity:0;transition:opacity .15s;transform:translateY(-50%)}
.rail-tooltip::before{content:'';position:absolute;left:-6px;top:50%;transform:translateY(-50%);border:6px solid transparent;border-right-color:var(--border)}
.rail-tooltip::after{content:'';position:absolute;left:-5px;top:50%;transform:translateY(-50%);border:5px solid transparent;border-right-color:var(--surface)}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
#channel-sidebar{background:var(--surface);display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:visible;backdrop-filter:blur(var(--sidebar-blur, 10px));-webkit-backdrop-filter:blur(var(--sidebar-blur, 10px));position:relative;z-index:2}
#sidebar-bg-layer{position:absolute;top:0;bottom:0;left:0;right:0;z-index:0;background-size:cover;background-position:center;opacity:0;transition:opacity .3s;pointer-events:none}
#sidebar-resize-handle{width:4px;cursor:col-resize;background:transparent;transition:background .15s;z-index:50;flex-shrink:0;position:relative}
#sidebar-resize-handle:hover,#sidebar-resize-handle.dragging{background:var(--accent)}
#sidebar-resize-handle::after{content:'';position:absolute;top:0;bottom:0;left:-3px;right:-3px}
#btn-friends{position:relative}
.friends-notif-badge{position:absolute;top:1px;right:1px;background:var(--danger,#f85149);color:#fff;font-size:9px;font-weight:700;min-width:15px;height:15px;border-radius:8px;display:none;align-items:center;justify-content:center;padding:0 4px;line-height:1;pointer-events:none}
#sidebar-bg-layer.show-image{opacity:1}
#sidebar-body{position:relative;z-index:1}
#sidebar-header{padding:14px 14px 10px;display:flex;flex-direction:column;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;z-index:2;background:var(--surface)}
#server-banner{height:80px;background-size:cover;background-position:center;border-radius:8px 8px 0 0;margin:-14px -14px 10px;display:none}
#server-banner.visible{display:block}
.sb-header-row{display:flex;flex-direction:column;gap:6px}
#sidebar-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-btn{background:none;border:none;color:var(--dim);font-size:17px;cursor:pointer;padding:3px 6px;border-radius:5px;transition:color .15s,background .15s}
.sb-btn:hover{color:var(--accent);background:var(--surface2)}
#sidebar-body{flex:1;overflow-y:auto;padding:6px 8px}
.sec-label{font-size:10px;font-weight:600;letter-spacing:1.3px;text-transform:uppercase;color:var(--dim);padding:10px 6px 4px;display:flex;align-items:center;justify-content:space-between}
.sec-label button{background:none;border:none;color:var(--dim);font-size:17px;cursor:pointer;transition:color .15s}
.sec-label button:hover{color:var(--accent)}
.ch-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:7px;cursor:pointer;transition:background .15s;white-space:nowrap;overflow:hidden;font-size:13.5px;color:var(--dim)}
.ch-item:hover{background:var(--surface2);color:var(--text)}
.ch-item.active{background:var(--surface2);color:var(--text);font-weight:600}
.ch-item .ch-icon{font-size:14px;flex-shrink:0;width:18px;text-align:center}
.ch-item .ch-name{overflow:hidden;text-overflow:ellipsis}
.dm-av-sm{width:24px;height:24px;border-radius:50%;flex-shrink:0;overflow:hidden}

/* Gradient sidebar body option */
#sidebar-body.gradient-bg{
  background:var(--sidebar-grad);
}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
#main-area{display:flex;flex-direction:column;overflow:hidden;position:relative}
#bg-layer{position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;background-attachment:fixed;transition:background .4s}
#bg-layer.has-img::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.42)}

/* header */
#chat-header{position:relative;z-index:2;padding:10px 18px;background:rgba(13,17,23,.82);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.hd-left{display:flex;align-items:center;gap:10px}
.hd-left h3{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text)}
.hd-sub{font-size:11px;color:var(--dim)}
.hd-btn{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;padding:4px 7px;border-radius:6px;transition:color .15s,background .15s}
.hd-btn:hover{color:var(--accent);background:rgba(88,166,255,.1)}

/* search window */
#search-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:200;background:var(--surface);border:1px solid var(--border);border-radius:16px;width:520px;max-width:90vw;max-height:80vh;display:none;box-shadow:0 12px 48px rgba(0,0,0,.6);flex-direction:column;overflow:hidden}
#search-window.show{display:flex}
#search-window-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
#search-window-header h3{font-family:'Syne',sans-serif;font-size:16px;font-weight:700}
#search-window-close{background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer;padding:0;transition:color .15s}
#search-window-close:hover{color:var(--danger)}
#search-window-input-wrap{padding:12px 18px;border-bottom:1px solid var(--border)}
#search-window-input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none}
#search-window-input:focus{border-color:var(--accent)}
#search-results-area{flex:1;overflow-y:auto;padding:12px 18px}
.search-result-item{padding:10px;margin-bottom:8px;background:var(--surface2);border-radius:8px;cursor:pointer;transition:background .15s}
.search-result-item:hover{background:var(--border)}
.search-result-user{font-weight:600;font-size:13px;margin-bottom:4px}
.search-result-text{font-size:13px;color:var(--dim);line-height:1.4}
.search-result-text mark{background:rgba(88,166,255,.25);color:var(--accent);padding:1px 3px;border-radius:3px}
.search-no-results{text-align:center;padding:40px 20px;color:var(--dim);font-size:13px}

/* messages */
#messages-wrap{position:relative;z-index:1;flex:1;overflow-y:auto;padding:14px 18px;display:flex;flex-direction:column;gap:2px}
.msg-row{display:flex;gap:10px;align-items:flex-start;padding:5px 6px;border-radius:8px;position:relative;cursor:default;opacity:1;transform:translateY(0);transition:opacity .2s,transform .2s}
.msg-row:hover{background:rgba(255,255,255,.035)}
.msg-row.highlight{animation:highlight 1s ease}
@keyframes highlight{0%,100%{background:rgba(255,255,255,.035)}50%{background:rgba(88,166,255,.15)}}
.msg-av{width:34px;height:34px;border-radius:50%;flex-shrink:0;overflow:hidden;cursor:pointer;border:2px solid transparent;transition:border-color .15s;display:flex;align-items:center;justify-content:center}
.msg-av:hover{border-color:var(--accent)}
.msg-av img{width:100%;height:100%;object-fit:cover}
.msg-av .default-av{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:18px}
.msg-body{flex:1;min-width:0}
.msg-hd{display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
.msg-name{font-weight:600;font-size:13.5px;cursor:pointer;transition:filter .15s}
.msg-name:hover{filter:brightness(1.3)}
.msg-time{font-size:10px;color:var(--dim)}
.msg-edited{font-size:10px;color:var(--dim);font-style:italic}
.msg-text{font-size:13.5px;line-height:1.55;color:var(--text);word-break:break-word}
.msg-text a{color:var(--accent)}
.msg-img{max-width:280px;border-radius:8px;margin-top:4px;display:block}
.reply-pre{border-left:3px solid var(--accent);padding:2px 8px;margin-bottom:3px;font-size:12px;color:var(--dim);background:rgba(255,255,255,.04);border-radius:0 5px 5px 0;cursor:pointer}
.reply-pre:hover{background:rgba(255,255,255,.08)}
.sys-msg{font-size:12px;color:var(--dim);text-align:center;padding:6px 0;font-style:italic}

/* reactions */
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.msg-react{display:flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(88,166,255,.12);border:1px solid rgba(88,166,255,.25);border-radius:12px;font-size:13px;cursor:pointer;transition:background .15s,border-color .15s}
.msg-react:hover{background:rgba(88,166,255,.22);border-color:var(--accent)}
.msg-react.mine{background:rgba(88,166,255,.25);border-color:var(--accent)}
.msg-react-count{font-size:11px;color:var(--dim);font-weight:600}

/* input */
#input-area{position:relative;z-index:2;padding:12px 18px 14px;background:rgba(13,17,23,.88);backdrop-filter:blur(10px);border-top:1px solid var(--border);flex-shrink:0}
#reply-bar{display:none;align-items:center;justify-content:space-between;padding:5px 10px;background:var(--surface2);border-radius:7px;margin-bottom:8px;font-size:12px;color:var(--dim)}
#reply-bar.show{display:flex}
#reply-bar button{background:none;border:none;color:var(--danger);cursor:pointer;font-size:15px}
.input-row{display:flex;align-items:center;gap:8px}
#msg-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:13.5px;font-family:inherit;resize:none;outline:none;max-height:120px;transition:border-color .2s}
#msg-input:focus{border-color:var(--accent)}
#msg-input::placeholder{color:var(--dim)}
.i-btn{width:38px;height:38px;border-radius:10px;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:filter .15s}
.i-btn:hover{filter:brightness(1.15)}
.i-btn.send{background:var(--grad);color:#fff}
.i-btn.att{background:var(--surface2);color:var(--dim);border:1px solid var(--border)}
.i-btn.att:hover,.i-btn.att.has{color:var(--accent);border-color:var(--accent)}
#file-input{display:none}

/* ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ */
#ctx-menu{position:fixed;z-index:300;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,.5);min-width:160px;display:none;overflow:hidden;animation:ci .15s cubic-bezier(.22,1,.36,1)}
@keyframes ci{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.ctx-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;font-size:13px;color:var(--text);transition:background .12s;white-space:nowrap}
.ctx-item:hover{background:var(--surface2)}
.ctx-item .ctx-ico{width:18px;text-align:center;font-size:15px}
.ctx-item.danger{color:var(--danger)}
.ctx-item.danger:hover{background:rgba(248,81,73,.12)}
.ctx-sep{height:1px;background:var(--border);margin:3px 0}

/* Channel context menu */
#ctx-channel{position:fixed;z-index:300;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,.5);min-width:160px;display:none;overflow:hidden;animation:ci .15s cubic-bezier(.22,1,.36,1)}

/* ‚îÄ‚îÄ‚îÄ PROFILE CARD ‚îÄ‚îÄ‚îÄ */
#profile-card{position:fixed;z-index:800;width:300px;border-radius:16px;overflow:hidden;box-shadow:0 12px 48px rgba(0,0,0,.6);display:none;animation:mi .2s cubic-bezier(.22,1,.36,1)}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.pc-banner{height:100px;background-size:cover;background-position:center;position:relative}
.pc-banner::after{content:'';position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(to bottom,transparent,var(--pc-primary,#161b22));pointer-events:none}
.pc-av{width:84px;height:84px;border-radius:50%;border:4px solid var(--pc-primary,#161b22);position:absolute;top:58px;left:50%;transform:translateX(-50%);overflow:hidden;background:#1c2333;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:5}
.pc-av img{width:100%;height:100%;object-fit:cover}
.pc-av .default-av{font-size:34px}
.pc-info{padding:52px 20px 8px;background:var(--pc-primary,#161b22);position:relative;z-index:1}
.pc-info::before{content:'';position:absolute;top:0;left:0;right:0;height:60px;background:linear-gradient(to bottom,var(--pc-accent-fade,rgba(88,166,255,.08)),transparent);pointer-events:none}
.pc-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;text-align:center;display:block;position:relative}
.pc-friend{display:none;font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;padding:3px 10px;border-radius:10px;margin-left:8px;vertical-align:middle}
.pc-bio{font-size:12px;color:#a0a8b3;margin-top:8px;min-height:16px;line-height:1.5;text-align:center;word-break:break-word;position:relative}
.pc-actions-wrap{padding:12px 20px 20px;background:var(--pc-primary,#161b22);position:relative}
.pc-actions-wrap::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--pc-accent-glow,rgba(88,166,255,.06)),var(--pc-secondary-glow,rgba(63,185,80,.04)));border-radius:0 0 16px 16px;pointer-events:none}
.pc-actions{display:flex;gap:8px;position:relative;z-index:1}
.pc-btn{flex:1;padding:10px 0;border-radius:10px;border:none;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;position:relative;overflow:hidden}
.pc-btn::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(255,255,255,.1),transparent 70%);opacity:0;transition:opacity .2s}
.pc-btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
.pc-btn:hover::after{opacity:1}
.pc-btn.pri{color:#fff}
.pc-btn.sec{background:rgba(255,255,255,.06);color:#c9d1d9;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(4px)}
.pc-btn.sec:hover{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.1)}
.pc-btn.pend{background:rgba(255,255,255,.04);color:#8b949e;border:1px solid rgba(255,255,255,.08);cursor:default;opacity:.7}
.pc-btn.pend:hover{transform:none;filter:none}
.pc-btn.gallery{color:#fff}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.ov{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.ov.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:420px;max-width:92vw;max-height:85vh;overflow-y:auto;position:relative;animation:mi .22s cubic-bezier(.22,1,.36,1)}
.modal h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;color:var(--text);margin-bottom:18px}
.modal-x{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer}
.modal-x:hover{color:var(--danger)}
.fr{margin-bottom:14px}
.fr label{display:block;font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
.fr input[type=text],.fr input[type=color],.fr textarea,.fr select{width:100%;padding:8px 11px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:border-color .2s}
.fr input:focus,.fr textarea:focus,.fr select:focus{border-color:var(--accent)}
.fr input[type=color]{height:36px;padding:3px;cursor:pointer}
.fr input[type=checkbox]{width:auto;margin-right:8px}
.fr select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px}
.two{display:flex;gap:10px}
.two .fr{flex:1}
.btn-row{display:flex;gap:8px;margin-top:18px}
.btn{padding:9px 18px;border-radius:8px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:filter .15s;flex:1;text-align:center}
.btn:hover{filter:brightness(1.12)}
.btn.pri{background:var(--accent);color:#fff}
.btn.grad{background:var(--grad);color:#fff}
.btn.sec{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn.dan{background:var(--danger);color:#fff}
.upload-box{border:2px dashed var(--border);border-radius:10px;padding:14px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;position:relative;overflow:hidden;min-height:90px;display:flex;align-items:center;justify-content:center}
.upload-box:hover{border-color:var(--accent);background:rgba(88,166,255,.05)}
.upload-box input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-box .ph{color:var(--dim);font-size:12px;pointer-events:none}
.upload-box img{max-width:100%;max-height:120px;border-radius:6px;pointer-events:none}
.grad-swatch{width:100%;height:28px;border-radius:8px;margin-top:6px;border:1px solid var(--border)}
.color-rounded{border-radius:10px!important;cursor:pointer}
.profile-grad-preview{width:100%;height:32px;border-radius:10px;margin-top:8px;border:1px solid var(--border);background:linear-gradient(135deg,#58a6ff,#3fb950)}
.checkbox-row{display:flex;align-items:center;font-size:13px;color:var(--text)}
/* USER SEARCH STYLES - START */
.user-search-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 8px;
    transition: border-color 0.2s;
}

.user-search-item:hover {
    border-color: var(--accent);
}

.user-search-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    overflow: hidden;
}

.user-search-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-search-info {
    flex: 1;
    min-width: 0;
}

.user-search-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
}

.user-search-username {
    font-size: 12px;
    color: var(--dim);
}

.user-search-actions {
    display: flex;
    gap: 8px;
}

.user-search-btn {
    padding: 7px 14px;
    border-radius: 7px;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.user-search-btn.primary {
    background: linear-gradient(135deg, #58a6ff, #3fb950);
    color: white;
}

.user-search-btn.secondary {
    background: var(--surface2);
    color: var(--dim);
    border: 1px solid var(--border);
}

.user-search-btn:hover {
    filter: brightness(1.15);
    transform: translateY(-1px);
}

.user-search-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.friend-request-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 8px;
}

.friend-request-actions {
    display: flex;
    gap: 6px;
}

.friend-request-actions button {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.friend-request-actions .accept-btn {
    background: #3fb950;
    color: white;
}

.friend-request-actions .decline-btn {
    background: #f85149;
    color: white;
}

.friend-request-actions button:hover {
    filter: brightness(1.2);
}
/* USER SEARCH STYLES - END */

/* Preview window positioning - side by side layout */
.ov.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* When both edit modal and preview are open, arrange side by side */
#m-profile.show ~ #m-profile-preview.show,
#m-ui.show ~ #m-ui-preview.show,
#m-srv.show ~ #m-srv-preview.show {
  display: flex !important;
  pointer-events: auto;
  background: transparent;
  backdrop-filter: none;
}

/* Position edit modals to the right */
#m-profile.show .modal,
#m-ui.show .modal,
#m-srv.show .modal {
  margin-left: auto;
  margin-right: 5vw;
}

/* Position preview modals to the left */
#m-profile-preview .modal,
#m-ui-preview .modal,
#m-srv-preview .modal {
  margin-right: auto;
  margin-left: 5vw;
}

/* Make sure both can be seen */
.ov.show .modal {
  box-shadow: 0 12px 48px rgba(0,0,0,.6);
}

/* Stack overlays properly when both are open */
#m-profile-preview,
#m-ui-preview,
#m-srv-preview {
  z-index: 701;
}

#m-profile,
#m-ui,
#m-srv {
  z-index: 700;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(3px);
}

/* Remove background from preview overlays */
#m-profile-preview,
#m-ui-preview,
#m-srv-preview {
  background: transparent !important;
  backdrop-filter: none !important;
}

/* members */
.mem-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border)}
.mem-row:last-child{border-bottom:none}
.mem-av{width:34px;height:34px;border-radius:50%;overflow:hidden;flex-shrink:0;cursor:pointer;border:2px solid transparent;transition:border-color .15s;display:flex;align-items:center;justify-content:center}
.mem-av:hover{border-color:var(--accent)}
.mem-av img{width:100%;height:100%;object-fit:cover}
.mem-av .default-av{font-size:16px}
.mem-name{font-weight:600;font-size:13px;cursor:pointer}
.mem-name:hover{filter:brightness(1.3)}
.tag{display:inline-block;font-size:10px;font-weight:600;letter-spacing:.7px;text-transform:uppercase;padding:2px 8px;border-radius:4px;background:rgba(88,166,255,.12);color:var(--accent)}

/* login */
#login-screen{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;flex-direction:column;background-color:#0a0d11;background-image:var(--login-bg);background-size:cover;background-position:center;background-attachment:fixed}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(0,0,0,.2) 0%,rgba(0,0,0,.5) 100%);z-index:0}

/* Frosted glass card */
.login-card{
  position:relative;
  z-index:1;
  background:linear-gradient(135deg,rgba(255,255,255,.08) 0%,rgba(255,255,255,.03) 50%,rgba(255,255,255,.06) 100%);
  backdrop-filter:blur(24px) saturate(1.4);
  -webkit-backdrop-filter:blur(24px) saturate(1.4);
  border-radius:28px;
  padding:48px 44px;
  width:400px;
  max-width:92vw;
  text-align:center;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.1) inset,
    0 0 40px 1px rgba(255,255,255,.03) inset,
    0 20px 60px rgba(0,0,0,.4),
    0 0 1px rgba(255,255,255,.2);
  overflow:hidden;
}

/* Glass edge light refraction - top highlight */
.login-card::before{
  content:'';
  position:absolute;
  top:0;
  left:20px;
  right:20px;
  height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.4) 20%,rgba(255,255,255,.5) 50%,rgba(255,255,255,.4) 80%,transparent);
  z-index:10;
}

/* Glass edge - bottom subtle reflection */
.login-card::after{
  content:'';
  position:absolute;
  bottom:0;
  left:40px;
  right:40px;
  height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.1) 30%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.1) 70%,transparent);
  z-index:10;
}

/* Inner glow overlay */
.login-card-glow{
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(ellipse at 30% 20%,rgba(255,255,255,.06) 0%,transparent 50%);
  pointer-events:none;
  z-index:0;
}

.login-card h1{
  position:relative;
  font-family:'Syne',sans-serif;
  font-size:36px;
  font-weight:800;
  margin-bottom:6px;
  color:#fff;
  text-shadow:0 2px 20px rgba(255,255,255,.15);
  letter-spacing:-0.5px;
}

.login-card .ls{
  position:relative;
  color:rgba(255,255,255,.6);
  font-size:13px;
  margin-bottom:30px;
  font-weight:400;
  letter-spacing:.5px;
}

.login-card .icon-glow{
  position:relative;
  font-size:52px;
  margin-bottom:12px;
  filter:drop-shadow(0 0 20px rgba(255,255,255,.2));
}

/* Glass input fields */
.login-card input{
  position:relative;
  width:100%;
  padding:14px 18px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  color:#fff;
  font-size:14px;
  font-family:inherit;
  outline:none;
  margin-bottom:12px;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 2px 10px rgba(0,0,0,.1) inset;
}

.login-card input::placeholder{
  color:rgba(255,255,255,.3);
  font-weight:400;
}

.login-card input:hover{
  background:rgba(255,255,255,.06);
  border-color:rgba(255,255,255,.12);
}

.login-card input:focus{
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.25);
  box-shadow:
    0 0 0 4px rgba(255,255,255,.05),
    0 2px 10px rgba(0,0,0,.1) inset;
}

/* Frosted glass button */
.login-btn{
  position:relative;
  width:100%;
  padding:15px;
  background:linear-gradient(135deg,rgba(255,255,255,.15) 0%,rgba(255,255,255,.05) 100%);
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  font-family:inherit;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.1) inset,
    0 4px 20px rgba(0,0,0,.2);
  overflow:hidden;
  letter-spacing:.5px;
}

/* Button shine effect */
.login-btn::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
  transition:left .5s ease;
}

.login-btn:hover{
  background:linear-gradient(135deg,rgba(255,255,255,.2) 0%,rgba(255,255,255,.08) 100%);
  border-color:rgba(255,255,255,.3);
  transform:translateY(-2px);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.15) inset,
    0 8px 30px rgba(0,0,0,.3),
    0 0 40px rgba(255,255,255,.05);
}

.login-btn:hover::before{
  left:100%;
}

.login-btn:active{
  transform:translateY(0);
  background:linear-gradient(135deg,rgba(255,255,255,.12) 0%,rgba(255,255,255,.04) 100%);
}

/* Glass tabs */
.login-tabs{
  position:relative;
  display:flex;
  gap:0;
  margin-bottom:26px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  padding:4px;
}

.login-tab{
  flex:1;
  padding:11px;
  border:none;
  background:transparent;
  color:rgba(255,255,255,.4);
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  border-radius:9px;
  transition:all .25s cubic-bezier(.4,0,.2,1);
  font-family:inherit;
  position:relative;
}

.login-tab.active{
  background:rgba(255,255,255,.1);
  color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
}

.login-tab:hover:not(.active){
  color:rgba(255,255,255,.7);
  background:rgba(255,255,255,.04);
}

/* Error/Success messages - glass style */
.login-error{
  position:relative;
  background:rgba(248,81,73,.1);
  border:1px solid rgba(248,81,73,.2);
  color:#ff6b6b;
  padding:12px 16px;
  border-radius:10px;
  font-size:12px;
  margin-bottom:12px;
  display:none;
  backdrop-filter:blur(8px);
}
.login-error.show{display:block}

.login-success{
  position:relative;
  background:rgba(63,185,80,.1);
  border:1px solid rgba(63,185,80,.2);
  color:#69db7c;
  padding:12px 16px;
  border-radius:10px;
  font-size:12px;
  margin-bottom:12px;
  display:none;
  backdrop-filter:blur(8px);
}
.login-success.show{display:block}

/* ‚îÄ‚îÄ‚îÄ GALLERY ‚îÄ‚îÄ‚îÄ */
#gallery-page{position:fixed;inset:0;z-index:600;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
#gallery-page.show{display:flex}
#gallery-header{position:relative;z-index:10;background:rgba(13,17,23,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
#gallery-header h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:700}
.gal-close-btn{background:var(--danger);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:filter .15s}
.gal-close-btn:hover{filter:brightness(1.15)}
#gallery-bg{position:fixed;inset:0;z-index:0;background-size:cover;background-position:center;background-attachment:fixed;transition:background .4s}
#gallery-bg.has-img::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.5)}
#gallery-content{position:relative;z-index:1;flex:1;overflow-y:auto;padding:24px}
#gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.gallery-item{border-radius:12px;overflow:hidden;background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:transform .2s,box-shadow .2s;position:relative}
.gallery-item:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.gallery-item img,.gallery-item video{width:100%;height:200px;object-fit:cover;display:block}
.gallery-item-del{position:absolute;top:8px;right:8px;background:var(--danger);color:#fff;border:none;width:28px;height:28px;border-radius:50%;font-size:14px;cursor:pointer;opacity:0;transition:opacity .2s}
.gallery-item:hover .gallery-item-del{opacity:1}
#gallery-controls{position:relative;z-index:10;padding:20px;background:rgba(13,17,23,.92);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap}
.gallery-empty{text-align:center;padding:80px 20px;color:var(--dim);font-size:14px}
#btn-gallery-settings{padding:8px 16px}

#gallery-content{position:relative;z-index:1}
#gallery-grid{position:relative;z-index:1}

/* scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--dim)}
</style>
</head>
<body>

<!-- LOGIN -->
<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-card-glow"></div>
    <div class="icon-glow">‚ú¶</div>
    <h1>Syntaxy</h1>
    <p class="ls">Theme it.</p>

    <div class="login-tabs">
      <button class="login-tab active" id="tab-login">Login</button>
      <button class="login-tab" id="tab-register">Register</button>
    </div>

    <div class="login-error" id="login-error"></div>
    <div class="login-success" id="login-success"></div>

    <input id="login-username" placeholder="Username" autocomplete="username">
    <input id="login-password" type="password" placeholder="Password" autocomplete="current-password">
    <input id="login-password-confirm" type="password" placeholder="Confirm Password" autocomplete="new-password" style="display:none">

    <button class="login-btn" id="login-btn">Login</button>
  </div>
</div>

<!-- LAYOUT -->
<div id="layout">
  <div id="server-rail"></div>
  <div class="rail-tooltip" id="rail-tooltip"></div>
  <div id="channel-sidebar">
  <div id="sidebar-bg-layer"></div>
  <div id="sidebar-header">
      <div id="server-banner"></div>
      <div class="sb-header-row">
        <h2 id="sidebar-title">Syntaxy</h2>
        <div style="display:flex;gap:2px;flex-wrap:wrap">
  <button class="sb-btn" id="btn-srv-set" title="Server Settings"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAABgklEQVR4nOWUvU4CURCFPzEW/vAEYCcmEMROfQxsaH0Cf55CetdO409pCDQGtdRGHsLCThslQpRoCK65ejbZ3FxWVrcw8SQ3uzP3zJm9M3cH/gu2AN9aG0kmOHYkOExKvADcSnRZy5fP7MXCGHAFNIAKsAu8S7APTGr15RuIU1GMiU1FJVhzlOIV2AHyIZ5597Rn842GEzPAnUh7QAu4AUoRH1QSp6UYXxppF3k7RJiQb1zPeZWgq1UHctoLSmJi7qVRdSVYBV5EONeJAvG2oxQPQOaT8cW9kN9olBmCJaAnYlG+huxTCWaBpnwn4hRl96QRiWeRp2V3ZQdfazAr31PoBL5iiZugIzubRAJXieqym0pixM/kq4mzMEqJykOanFND7SY/AnNxmlx1XNOUnhk1tKNVC4mPfE3TP/jRFsW5Bva/+9GiRoVnjYqCZtBbnFERDLtLNbYi4YE17KasYeeJW1es0YiFvDWuV0LjOnyqX+HIUYoDEsSmI8F6kgn+Lj4A8qSo0U5gVbgAAAAASUVORK5CYII=" class="icon-img invert" alt=""></button>
  <button class="sb-btn" id="btn-profile" title="My Profile"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA70lEQVR4nO3UQUrDQBSH8R8umqVdWrrWK+hJxEPYHsNuRPFAurR1ZfEAuinVlUUUXVYGJiCCdNJObCn54A8heeGbl8wbGjaUAn2M8BETrnvxWS10Mcb8j9zHmqwUC6Q/5Vk77ydIy5zmFN9VEA9zit8riENtNuYVs5aO37biH/fWtauLOKMpc9ySme4CeS0nV0krfsph3HAht/Fe9k4b/pUdHGGAGzzjK2aKa5zhMNauTAcXeKkwx2FR59hbRtjGFT6XOKfLhHcvsZsqPcDTCsLfecR+ivgho7TMOEU8rUE8SRGfYJZR+orjFHHDdvENyZP0ibBvoI8AAAAASUVORK5CYII=" class="icon-img invert" alt=""></button>
  <button class="sb-btn" id="btn-friends" title="Friends">üë•<span class="friends-notif-badge" id="friends-notif-badge"></span></button>
  <button class="sb-btn" id="btn-ui" title="UI Settings"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVR4nO2UMQ7CMAxF38gNIrgOHYDTcAkWmHsVzsGCaFe4A6tRJSPSqjgJCVue5CWy/7edKFCeJXABjvyJFhCNU+nO98ACOKvBMMmIHfDwOhAjnkDjiXd6flCTVs9H5IqLxjDJLO+EWBxwnYj3wKqEgUsVJ2Et7hdxMnZ+8y50HWNg0RnijTaTZSBfxFFxKWXQz+w8WJ/6TKdUgyDVIEiwPva7FiPulsFWE3LEN+FBK3x4AdaaoWW8RUr6AAAAAElFTkSuQmCC" class="icon-img invert" alt=""></button>
  <button class="sb-btn" id="btn-logout" title="Logout" style="color:var(--danger)">‚èª</button>
</div>
      </div>
    </div>
    <div id="sidebar-body"></div>
  </div>
  <div id="sidebar-resize-handle"></div>
  <div id="main-area">
    <div id="bg-layer"></div>
    <div id="chat-header">
      <div class="hd-left">
        <span id="hd-icon" style="font-size:18px">#</span>
        <div><h3 id="hd-name">general</h3><span class="hd-sub" id="hd-desc"></span></div>
      </div>
      <div style="display:flex;gap:2px">
  <button class="hd-btn" id="btn-search" title="Search Messages (Ctrl+F)"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVR4nO2USwrCQBBE397PSr2OxhsoXkXEhajJxtsoeg6NN/G71ZGBCgQhTjJBFLGgITDVXUNNdeBX0QIiIAauqh0QAs2ywwfAGTAZdQL6ZYbfNWgJtIGKqgOsdHYDej62JDcfvuCNxDkCjSICUermLqzFnRcR2KvJ2uJCIK59+Ny4qKmag1sT11qaG+cCAnUfgVhNNi0udH0sCtVko+jCRtxZEYGmlsgoilkYi3Pw2eq+lsgoioHepCpbkpvbmuCJnpYo61dx0HDjY1OChpZoq/he9T1P2WLKirgwehJZ/EW+SmTKmzB7V6I+hweEGmSrsOKf7QAAAABJRU5ErkJggg==" class="icon-img invert" alt=""></button>
  <button class="hd-btn" id="btn-chbg" title="Background"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAABVElEQVR4nO3VvSuGYRQG8B+xKa9FGSxKUgYLZmU2MLAoWaRksFjfjUn5+gN8bDab/8AosUgZJEX5KiEfr5466unN+/G8jK46y32fc67nnOvc5+EfGZHDDh5QyGhJzHbkKIkk+TPWsZTR1iN2qxxB8hUrascq7ss5JKXmq0hUh1HMoSN1no8cvybYSPX+MUXyZwSPIWhnxMz/NcExzrAZMaO1ENRjDLNoKfIbwBHusBa+mQgasZvq83mRmKVQFcEi9vAZve3HDS7QFX4NmMAMmrISJI/lA9Op8x5chfVhP1XdCdqyELxj8oe7rqjiM3ymMBiP8xTt1RIsl7hrxgHeMF4k+G3otFnrmOYi+StGfrjvxXWqbZkIWnGIFwyXie3GZSWCh1hY32gLEZ8wpDLWKi277ZiiZKMuhHiFGNuFCrYSVSY6lEQu9nktP5z7SJ4Mwz9UjS9tAZDbZ49V0wAAAABJRU5ErkJggg==" class="icon-img invert" alt=""></button>
  <button class="hd-btn" id="btn-members" title="Members"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVR4nO2UO0sDQRSFv0KxUoLFIhoLC3+PD7Cx9vHTNASrxMpKEDFgt4X21oqmNbAycIRhmZ2dO4lFcA/cZua7556ZWRY6LYH6wBCYqm6A/Tk48/B3oKqVW9vJ4MwaymgkI1djrQ0yOLOmMvFPsau1zwzOrC+Z9FuMUzmzrmUylrmrW61dedwgkTNrD5gFPq6Z9nzuO4EzaRuYBEx/6xnYEnsW4SbyMmnNG/4CHADrqkPg1QuxAqwCd8CpQjnuyOOe5JmsC294L7Df88wvIz6bwJu4c0uARzW5kzfpWMx9i9eJuAdLgA81uats0kbk3UOc+ysmqwoYxbhYAItffkOLljdAsYDhRU6AUg1lQ4i6YdOAouZlSl1GGlMDtB0k++pSA8z9lNWCAmSr6gLQBeCfB+jEX+sHlivc7NzpAGsAAAAASUVORK5CYII=" class="icon-img invert" alt=""></button>
</div>
    </div>
    <div id="messages-wrap"></div>
    <div id="input-area">
      <div id="reply-bar"><span id="reply-label">Replying‚Ä¶</span><button id="btn-cancel-reply">‚úï</button></div>
      <div class="input-row">
        <button class="i-btn att" id="btn-attach"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAABd0lEQVR4nO2WsU7CUBSGv8luAhprLMpb+CAmogMLDwAOvqEuYFQ0wQFIiIObOgmTDJib/CQ3zS0p9NSJP7kJLSfn7zn33K+FnbZXBHSBPjDX6uteREk6BV6BZcZ6AerWpg1gKoMRcAHsAwnQBMaeuVnlZ56pa2s1EFPzzDsWppHXXmdaWRPb9OIK60bJ3jMq9ZUo9sfC+EHJXDX8p/FMyQ51HQPPwF0g9kqxPQvjLyU7kulQ164Tvtw2TCyH617JboE3/R7qIVaqaKCWwMDqOLVTkEib1jzTqY6eidzA/AZMj4EW8OGZNoqw91vtbct0GDC9BhZeFwbCqRl7Q5WeA596yJ4Gac+CvQfqQNaelsbeeM30lsbeOGNPXXvN2DsKsPcxY5Dcnpqx9zLwnxuWp9SRWViz9yRHbMuSvbOcxjUPDibs7ed4zZXC3q4SjlVVWtWy2Bvpg2xl3hQaE71PJ9uyN4/qnnlobczeTSvvaGLnRdi7E57+APHIojLsmNzxAAAAAElFTkSuQmCC" class="icon-img invert" style="width:20px;height:20px" alt=""></button>
        <input type="file" id="file-input" accept="image/*,image/gif">
        <textarea id="msg-input" rows="1" placeholder="Message‚Ä¶"></textarea>
        <button class="i-btn send" id="btn-send">‚Üµ</button>
      </div>
    </div>
  </div>
</div>

<!-- SEARCH WINDOW -->
<div id="search-window">
  <div id="search-window-header">
    <h3><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVR4nO2USwrCQBBE397PSr2OxhsoXkXEhajJxtsoeg6NN/G71ZGBCgQhTjJBFLGgITDVXUNNdeBX0QIiIAauqh0QAs2ywwfAGTAZdQL6ZYbfNWgJtIGKqgOsdHYDej62JDcfvuCNxDkCjSICUermLqzFnRcR2KvJ2uJCIK59+Ny4qKmag1sT11qaG+cCAnUfgVhNNi0udH0sCtVko+jCRtxZEYGmlsgoilkYi3Pw2eq+lsgoioHepCpbkpvbmuCJnpYo61dx0HDjY1OChpZoq/he9T1P2WLKirgwehJZ/EW+SmTKmzB7V6I+hweEGmSrsOKf7QAAAABJRU5ErkJggg==" class="icon-img invert" style="vertical-align:middle;margin-right:8px" alt="">Search Messages</h3>
    <button id="search-window-close">‚úï</button>
  </div>
  <div id="search-window-input-wrap">
    <input type="text" id="search-window-input" placeholder="Search for keywords‚Ä¶" autocomplete="off">
  </div>
  <div id="search-results-area"></div>
</div>

<!-- CTX MENU -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-reply"><span class="ctx-ico">‚Ü©</span>Reply</div>
  <div class="ctx-item" id="ctx-copy"><span class="ctx-ico">üìã</span>Copy Text</div>
  <div class="ctx-item" id="ctx-react"><span class="ctx-ico">üòÄ</span>React</div>
  <div class="ctx-item" id="ctx-edit" style="display:none"><span class="ctx-ico">‚úèÔ∏è</span>Edit</div>
  <div class="ctx-sep" id="ctx-sep" style="display:none"></div>
  <div class="ctx-item danger" id="ctx-delete" style="display:none"><span class="ctx-ico">üóëÔ∏è</span>Delete</div>
</div>

<!-- CHANNEL CTX MENU -->
<div id="ctx-channel">
  <div class="ctx-item" id="ctx-ch-edit"><span class="ctx-ico">‚úèÔ∏è</span>Edit Channel</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" id="ctx-ch-delete"><span class="ctx-ico">üóëÔ∏è</span>Delete Channel</div>
</div>

<!-- PROFILE CARD -->
<div id="profile-card">
  <div class="pc-banner" id="pc-banner"></div>
  <div class="pc-av" id="pc-av"></div>
  <div class="pc-info">
    <div style="text-align:center"><span class="pc-name" id="pc-name"></span><span class="pc-friend" id="pc-friend">‚úì Friend</span></div>
    <div class="pc-bio" id="pc-bio"></div>
  </div>
  <div class="pc-actions-wrap">
    <div class="pc-actions" id="pc-actions"></div>
  </div>
</div>

<!-- Profile Preview Window -->
<div class="ov" id="m-profile-preview" style="pointer-events:none">
  <div class="modal" style="width:340px;pointer-events:auto">
    <h3 style="margin-bottom:16px">Live Preview</h3>
    <div id="preview-profile-card" style="width:300px;border-radius:16px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.3);margin:0 auto">
      <div class="pc-banner" id="preview-pc-banner" style="height:100px;background-size:cover;background-position:center;position:relative"></div>
      <div class="pc-av" id="preview-pc-av" style="width:84px;height:px;border-radius:50%;border:4px solid var(--pc-primary,#161b22);position:absolute;top:127px;left:57%;transform:translateX(-50%);overflow:hidden;background:#1c2333;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:5;margin-left:-20px"></div>
      <div class="pc-info" style="padding:52px 20px 8px;background:var(--pc-primary,#161b22);position:relative;z-index:1">
        <div style="text-align:center">
          <span class="pc-name" id="preview-pc-name" style="font-family:'Syne',sans-serif;font-size:18px;font-weight:700;display:block"></span>
        </div>
        <div class="pc-bio" id="preview-pc-bio" style="font-size:12px;color:#a0a8b3;margin-top:8px;min-height:16px;line-height:1.5;text-align:center"></div>
      </div>
      <div class="pc-actions-wrap" style="padding:12px 20px 20px;background:var(--pc-primary,#161b22);position:relative">
        <div class="pc-actions" style="display:flex;gap:8px;position:relative;z-index:1">
          <button class="pc-btn pri" id="preview-profile-btn" style="flex:1;padding:10px 0;border-radius:10px;border:none;font-size:12px;font-weight:600;cursor:default;color:#fff">Sample Button</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- USER SEARCH MODAL -->
<div id="user-search-overlay" class="ov">
    <div class="modal" style="width: 500px">
        <button id="user-search-close" class="modal-x">√ó</button>
        <h3>üîç Search Users</h3>

        <div class="fr">
            <label>Search by Username</label>
            <input type="text" id="user-search-input" placeholder="Type username...">
        </div>

        <div id="user-search-results" style="margin-top: 16px; max-height: 400px; overflow-y: auto;">
        </div>
    </div>
</div>

<!-- FRIEND REQUESTS MODAL -->
<div class="ov" id="m-friends">
  <div class="modal" style="width:460px">
    <button class="modal-x" data-close="m-friends">‚úï</button>
    <h3>üë• Friends</h3>
    <div style="display:flex;gap:0;margin:12px 0 16px;border-bottom:2px solid var(--border)">
      <button class="friends-tab active" id="tab-friends-list" style="flex:1;padding:10px;background:none;border:none;color:var(--text);font-weight:600;font-size:13px;cursor:pointer;border-bottom:2px solid var(--accent);margin-bottom:-2px;font-family:Inter,sans-serif">Friends</button>
      <button class="friends-tab" id="tab-friends-requests" style="flex:1;padding:10px;background:none;border:none;color:var(--dim);font-weight:600;font-size:13px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-family:Inter,sans-serif">Requests <span id="req-count-badge" style="display:none;background:var(--danger);color:#fff;font-size:11px;padding:1px 6px;border-radius:10px;margin-left:4px">0</span></button>
    </div>
    <div id="friends-tab-content" style="max-height:380px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent">
      <div id="friends-list-panel"></div>
      <div id="friends-requests-panel" style="display:none"></div>
    </div>
  </div>
</div>

<!-- MODALS -->\

<!-- Profile -->
<div class="ov" id="m-profile">
  <div class="modal" style="width:400px">
    <button class="modal-x" data-close="m-profile">‚úï</button>
    <h3><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA70lEQVR4nO3UQUrDQBSH8R8umqVdWrrWK+hJxEPYHsNuRPFAurR1ZfEAuinVlUUUXVYGJiCCdNJObCn54A8heeGbl8wbGjaUAn2M8BETrnvxWS10Mcb8j9zHmqwUC6Q/5Vk77ydIy5zmFN9VEA9zit8riENtNuYVs5aO37biH/fWtauLOKMpc9ySme4CeS0nV0krfsph3HAht/Fe9k4b/pUdHGGAGzzjK2aKa5zhMNauTAcXeKkwx2FR59hbRtjGFT6XOKfLhHcvsZsqPcDTCsLfecR+ivgho7TMOEU8rUE8SRGfYJZR+orjFHHDdvENyZP0ibBvoI8AAAAASUVORK5CYII=" class="icon-img invert" style="vertical-align:middle;margin-right:8px" alt="">Edit Profile</h3>

    <div class="fr"><label>Display Name</label><input type="text" id="p-name" maxlength="24" placeholder="Your display name"></div>

    <div class="fr">
      <label>Bio <span id="bio-counter" style="float:right;font-weight:400;opacity:.7">0/50</span></label>
      <input type="text" id="p-bio" maxlength="50" placeholder="Tell us about yourself‚Ä¶">
    </div>

    <h4 style="margin:20px 0 12px;font-size:13px;color:var(--text);font-weight:600">Profile Theme</h4>
    <p style="font-size:11px;color:var(--dim);margin-bottom:12px">Your main color fills the card. Accent color highlights buttons & banner.</p>

    <div class="two">
      <div class="fr">
        <label>Main Color</label>
        <input type="color" id="p-color" value="#58a6ff" class="color-rounded">
      </div>
      <div class="fr">
        <label>Accent Color</label>
        <input type="color" id="p-accent" value="#3fb950" class="color-rounded">
      </div>
    </div>
    <p style="font-size:10px;color:var(--dim);margin:8px 0 4px">Button Gradient Preview:</p>
    <div class="profile-grad-preview" id="profile-grad-preview"></div>

    <h4 style="margin:20px 0 12px;font-size:13px;color:var(--text);font-weight:600">Media</h4>

    <div class="fr"><label>Avatar</label>
      <div class="upload-box" id="ub-avatar"><input type="file" accept="image/*,image/gif"><span class="ph">Click to upload avatar</span></div>
    </div>
    <div class="fr"><label>Banner</label>
      <div class="upload-box" id="ub-banner"><input type="file" accept="image/*,image/gif"><span class="ph">Click to upload banner</span></div>
    </div>

    <div class="btn-row">
      <button class="btn grad" id="btn-save-prof">Save Changes</button>
      <button class="btn sec" data-close="m-profile">Cancel</button>
    </div>
  </div>
</div>

<!-- UI Settings -->
<div class="ov" id="m-ui">
  <div class="modal">
    <button class="modal-x" data-close="m-ui">‚úï</button>
    <h3>üé® Personal UI Settings</h3>
    <p style="font-size:12px;color:var(--dim);margin-bottom:14px">Customize how Syntaxy looks for you. Colors update live.</p>

    <div class="fr">
      <div class="checkbox-row">
        <input type="checkbox" id="ui-override">
        <label for="ui-override" style="margin:0;text-transform:none;letter-spacing:0">Override Server Aesthetics (use my custom UI everywhere)</label>
      </div>
    </div>

    <div class="two">
      <div class="fr"><label>Background</label><input type="color" id="ui-bg" value="#0d1117"></div>
      <div class="fr"><label>Surface</label><input type="color" id="ui-surf" value="#161b22"></div>
    </div>
    <div class="two">
      <div class="fr"><label>Accent Start</label><input type="color" id="ui-acc1" value="#58a6ff"></div>
      <div class="fr"><label>Accent End</label><input type="color" id="ui-acc2" value="#3fb950"></div>
    </div>
    <div class="grad-swatch" id="ui-grad-swatch" style="background:linear-gradient(135deg,#58a6ff,#3fb950)"></div>
    <div class="two" style="margin-top:14px">
      <div class="fr"><label>Text</label><input type="color" id="ui-text" value="#c9d1d9"></div>
      <div class="fr"><label>Border</label><input type="color" id="ui-border" value="#30363d"></div>
    </div>
    <div class="fr"><label>Sidebar Background Style</label>
      <select id="ui-sidebar-style">
        <option value="solid">Solid Color</option>
        <option value="gradient">Gradient</option>
      </select>
    </div>
  <div class="fr">
  <label>Sidebar Opacity <span id="ui-opacity-val" style="float:right;font-weight:400;opacity:.7">100%</span></label>
  <input type="range" id="ui-sidebar-opacity" min="0" max="100" value="100" style="width:100%;cursor:pointer">
</div>
<div class="fr">
  <label>Sidebar Blur <span id="ui-blur-val" style="float:right;font-weight:400;opacity:.7">10px</span></label>
  <input type="range" id="ui-sidebar-blur" min="0" max="30" value="10" style="width:100%;cursor:pointer">
</div>
<div class="fr">
  <label>Sidebar Background Mode</label>
  <select id="ui-sidebar-bg-mode">
    <option value="color">Solid Color (behind blur)</option>
    <option value="image">Show Channel Background Image</option>
  </select>
</div>
    <div id="ui-sidebar-grad-controls" style="display:none">
      <div class="two">
        <div class="fr"><label>Sidebar Grad Start</label><input type="color" id="ui-sb-grad1" value="#161b22"></div>
        <div class="fr"><label>Sidebar Grad End</label><input type="color" id="ui-sb-grad2" value="#1c2333"></div>
      </div>
      <div class="grad-swatch" id="ui-sidebar-grad-swatch" style="background:linear-gradient(135deg,#161b22,#1c2333)"></div>
    </div>
    <div class="btn-row">
      <button class="btn grad" id="btn-save-ui">Save</button>
      <button class="btn sec" id="btn-reset-ui">Reset</button>
      <button class="btn sec" data-close="m-ui">Close</button>
    </div>
  </div>
</div>

<!-- Personal UI Preview Window -->
<div class="ov" id="m-ui-preview" style="pointer-events:none">
  <div class="modal" style="width:500px;pointer-events:auto">
    <h3 style="margin-bottom:16px">Live Preview</h3>
    <div id="preview-ui-sample" style="border:1px solid var(--border);border-radius:12px;overflow:hidden">
      <!-- Mini sidebar -->
      <div style="display:flex;height:300px">
        <div id="preview-ui-sidebar" style="width:180px;padding:12px;display:flex;flex-direction:column;gap:6px">
          <div style="font-size:11px;font-weight:600;opacity:0.6;margin-bottom:4px">CHANNELS</div>
          <div style="padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.08)"># general</div>
          <div style="padding:6px 8px;border-radius:6px;opacity:0.7"># random</div>
          <div style="padding:6px 8px;border-radius:6px;opacity:0.7"># announcements</div>
        </div>
        <!-- Mini main area -->
        <div id="preview-ui-main" style="flex:1;display:flex;flex-direction:column">
          <div id="preview-ui-header" style="padding:10px 14px;border-bottom:1px solid;display:flex;align-items:center;gap:8px">
            <span style="font-size:14px;font-weight:600"># general</span>
          </div>
          <div id="preview-ui-content" style="flex:1;padding:14px;display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;gap:8px;align-items:start">
              <div style="width:28px;height:28px;border-radius:50%;opacity:0.7" id="preview-ui-avatar"></div>
              <div style="flex:1">
                <div style="font-weight:600;font-size:12px;margin-bottom:2px">User</div>
                <div style="font-size:12px;opacity:0.9">Sample message text</div>
              </div>
            </div>
          </div>
          <div id="preview-ui-input" style="padding:10px 14px;border-top:1px solid">
            <div style="padding:8px 12px;border-radius:8px;border:1px solid;font-size:12px;opacity:0.6">
              Message #general...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Server Settings -->
<div class="ov" id="m-srv">
  <div class="modal" style="width:460px">
    <button class="modal-x" data-close="m-srv">‚úï</button>
    <h3><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAABgklEQVR4nOWUvU4CURCFPzEW/vAEYCcmEMROfQxsaH0Cf55CetdO409pCDQGtdRGHsLCThslQpRoCK65ejbZ3FxWVrcw8SQ3uzP3zJm9M3cH/gu2AN9aG0kmOHYkOExKvADcSnRZy5fP7MXCGHAFNIAKsAu8S7APTGr15RuIU1GMiU1FJVhzlOIV2AHyIZ5597Rn842GEzPAnUh7QAu4AUoRH1QSp6UYXxppF3k7RJiQb1zPeZWgq1UHctoLSmJi7qVRdSVYBV5EONeJAvG2oxQPQOaT8cW9kN9olBmCJaAnYlG+huxTCWaBpnwn4hRl96QRiWeRp2V3ZQdfazAr31PoBL5iiZugIzubRAJXieqym0pixM/kq4mzMEqJykOanFND7SY/AnNxmlx1XNOUnhk1tKNVC4mPfE3TP/jRFsW5Bva/+9GiRoVnjYqCZtBbnFERDLtLNbYi4YE17KasYeeJW1es0YiFvDWuV0LjOnyqX+HIUYoDEsSmI8F6kgn+Lj4A8qSo0U5gVbgAAAAASUVORK5CYII=" class="icon-img invert" style="vertical-align:middle;margin-right:8px" alt="">Server Settings</h3>
    <div class="fr"><label>Name</label><input type="text" id="s-name"></div>
    <div class="fr"><label>Icon</label><div class="upload-box" id="ub-srv-icon"><input type="file" accept="image/*,image/gif"><span class="ph">Upload icon</span></div></div>
    <div class="fr"><label>Banner</label><div class="upload-box" id="ub-srv-ban"><input type="file" accept="image/*,image/gif"><span class="ph">Upload banner</span></div></div>

    <h3 style="margin-top:24px;margin-bottom:12px;font-size:16px">Server Aesthetics</h3>
    <p style="font-size:12px;color:var(--dim);margin-bottom:14px">Customize the look for all members of this server.</p>

    <div class="two">
      <div class="fr"><label>Background</label><input type="color" id="s-bg" value="#0d1117"></div>
      <div class="fr"><label>Surface</label><input type="color" id="s-surf" value="#161b22"></div>
    </div>
    <div class="two">
      <div class="fr"><label>Accent Start</label><input type="color" id="s-acc1" value="#58a6ff"></div>
      <div class="fr"><label>Accent End</label><input type="color" id="s-acc2" value="#3fb950"></div>
    </div>
    <div class="grad-swatch" id="s-grad-swatch" style="background:linear-gradient(135deg,#58a6ff,#3fb950)"></div>
    <div class="two" style="margin-top:14px">
      <div class="fr"><label>Text</label><input type="color" id="s-text" value="#c9d1d9"></div>
      <div class="fr"><label>Border</label><input type="color" id="s-border" value="#30363d"></div>
    </div>
    <div class="fr"><label>Sidebar Style</label>
      <select id="s-sidebar-style">
        <option value="solid">Solid Color</option>
        <option value="gradient">Gradient</option>
      </select>
    </div>
   <div id="s-sidebar-grad-controls" style="display:none">
  <div class="two">
    <div class="fr"><label>Sidebar Grad Start</label><input type="color" id="s-sb-grad1" value="#161b22"></div>
    <div class="fr"><label>Sidebar Grad End</label><input type="color" id="s-sb-grad2" value="#1c2333"></div>
  </div>
  <div class="grad-swatch" id="s-sidebar-grad-swatch" style="background:linear-gradient(135deg,#161b22,#1c2333)"></div>
</div>

<div class="fr">
  <label>Sidebar Opacity <span id="s-opacity-val" style="float:right;font-weight:400;opacity:.7">100%</span></label>
  <input type="range" id="s-sidebar-opacity" min="0" max="100" value="100" style="width:100%;cursor:pointer">
</div>
<div class="fr">
  <label>Sidebar Blur <span id="s-blur-val" style="float:right;font-weight:400;opacity:.7">10px</span></label>
  <input type="range" id="s-sidebar-blur" min="0" max="30" value="10" style="width:100%;cursor:pointer">
</div>
<div class="fr">
  <label>Sidebar Background Mode</label>
  <select id="s-sidebar-bg-mode">
    <option value="color">Solid Color (behind blur)</option>
    <option value="image">Show Channel Background Image</option>
  </select>
</div>

<div class="fr" style="margin-top:14px"><label>Default Channel BG</label>
    <div class="upload-box" id="ub-srv-chbg"><input type="file" accept="image/*,image/gif"><span class="ph">Default channel bg</span></div></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-save-srv">Save</button>
      <button class="btn sec" id="btn-invite-srv" style="background:linear-gradient(135deg,#58a6ff,#3fb950);color:white;border:none">üîó Invite</button>
      <button class="btn sec" data-close="m-srv">Cancel</button>
    </div>
  </div>
</div>

<!-- Server Preview Window - UNIQUE PER SERVER -->
<div class="ov" id="m-srv-preview" style="pointer-events:none">
  <div class="modal" style="width:520px;pointer-events:auto">
    <h3 style="margin-bottom:16px">Server Preview</h3>

    <!-- Server Rail Icon Preview -->
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:600;color:var(--dim);margin-bottom:8px">SERVER ICON</div>
      <div style="display:flex;gap:8px;align-items:center;padding:12px;background:var(--surface2);border-radius:10px">
        <div id="preview-srv-rail-icon" class="rail-icon" style="position:relative;border-color:var(--accent)"></div>
        <span style="font-size:13px;opacity:0.8">This is how your server appears in the rail</span>
      </div>
    </div>

    <!-- Server UI Preview -->
    <div style="border:1px solid var(--border);border-radius:12px;overflow:hidden">
      <!-- Banner preview -->
      <div id="preview-srv-banner" style="height:80px;background-size:cover;background-position:center;display:none"></div>

      <div style="display:flex;height:280px">
        <!-- Mini sidebar -->
        <div id="preview-srv-sidebar" style="width:180px;padding:12px;display:flex;flex-direction:column;gap:6px">
          <div id="preview-srv-title" style="font-size:13px;font-weight:700;margin-bottom:8px"></div>
          <div style="font-size:11px;font-weight:600;opacity:0.6;margin-bottom:4px">CHANNELS</div>
          <div style="padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.08)"># general</div>
          <div style="padding:6px 8px;border-radius:6px;opacity:0.7"># random</div>
        </div>

        <!-- Mini main area -->
        <div id="preview-srv-main" style="flex:1;display:flex;flex-direction:column;position:relative">
          <!-- Background layer -->
          <div id="preview-srv-bg" style="position:absolute;inset:0;background-size:cover;background-position:center;z-index:0"></div>

          <div style="position:relative;z-index:1;display:flex;flex-direction:column;height:100%">
            <div id="preview-srv-header" style="padding:10px 14px;border-bottom:1px solid;background:rgba(13,17,23,0.82);backdrop-filter:blur(10px)">
              <span style="font-size:14px;font-weight:600"># general</span>
            </div>
            <div id="preview-srv-content" style="flex:1;padding:14px;display:flex;flex-direction:column;gap:8px">
              <div style="display:flex;gap:8px;align-items:start">
                <div style="width:28px;height:28px;border-radius:50%;opacity:0.7" id="preview-srv-avatar"></div>
                <div style="flex:1">
                  <div style="font-weight:600;font-size:12px;margin-bottom:2px">User</div>
                  <div style="font-size:12px;opacity:0.9">Sample message</div>
                </div>
              </div>
            </div>
            <div id="preview-srv-input" style="padding:10px 14px;border-top:1px solid;background:rgba(13,17,23,0.88);backdrop-filter:blur(10px)">
              <div style="padding:8px 12px;border-radius:8px;border:1px solid;font-size:12px;opacity:0.6">
                Message...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Server -->
<div class="ov" id="m-newsrv">
  <div class="modal">
    <button class="modal-x" data-close="m-newsrv">‚úï</button>
    <h3>Create a Server</h3>
    <div class="fr"><label>Name</label><input type="text" id="ns-name" placeholder="My Server"></div>
    <div class="fr"><label>Icon</label><div class="upload-box" id="ub-ns-icon"><input type="file" accept="image/*,image/gif"><span class="ph">Upload icon</span></div></div>
    <div class="fr"><label>Accent</label><input type="color" id="ns-accent" value="#58a6ff"></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-do-newsrv">Create</button>
      <button class="btn sec" data-close="m-newsrv">Cancel</button>
    </div>
  </div>
</div>

<!-- Join Server via Invite -->
<div class="ov" id="m-joinsrv">
  <div class="modal">
    <button class="modal-x" data-close="m-joinsrv">‚úï</button>
    <h3>Join a Server</h3>
    <p style="font-size:13px;color:var(--dim);margin-bottom:12px">Enter an invite code to join a server</p>
    <div class="fr"><label>Invite Code</label><input type="text" id="join-invite-code" placeholder="e.g. a1b2c3d4" autocomplete="off"></div>
    <div id="invite-preview" style="display:none;padding:14px;background:var(--surface2);border-radius:10px;margin:12px 0">
      <div style="display:flex;align-items:center;gap:10px">
        <div id="invite-srv-icon" style="width:44px;height:44px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;overflow:hidden"></div>
        <div>
          <div id="invite-srv-name" style="font-weight:700;font-size:15px"></div>
          <div id="invite-srv-members" style="font-size:12px;color:var(--dim)"></div>
        </div>
      </div>
    </div>
    <div id="invite-error" style="display:none;color:#f85149;font-size:13px;margin:8px 0"></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-do-joinsrv">Join Server</button>
      <button class="btn sec" data-close="m-joinsrv">Cancel</button>
    </div>
  </div>
</div>

<!-- Invite Code Display -->
<div class="ov" id="m-invite">
  <div class="modal">
    <button class="modal-x" data-close="m-invite">‚úï</button>
    <h3>Invite People</h3>
    <p style="font-size:13px;color:var(--dim);margin-bottom:12px">Share this code with others so they can join your server</p>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="text" id="invite-code-display" readonly style="flex:1;font-family:monospace;font-size:16px;letter-spacing:2px;text-align:center;background:var(--surface2);border:1px solid var(--border);padding:12px;border-radius:8px;color:var(--text)">
      <button class="btn pri" id="btn-copy-invite" style="white-space:nowrap">üìã Copy</button>
    </div>
    <div id="invite-copied-msg" style="display:none;color:var(--accent);font-size:13px;text-align:center;margin-top:8px">Copied!</div>
    <button class="btn pri" id="btn-new-invite" style="width:100%;margin-top:12px">Generate New Code</button>
  </div>
</div>

<!-- Create Channel -->
<div class="ov" id="m-newch">
  <div class="modal">
    <button class="modal-x" data-close="m-newch">‚úï</button>
    <h3>Create Channel</h3>
    <div class="fr"><label>Name</label><input type="text" id="nc-name" placeholder="my-channel"></div>
    <div class="fr"><label>Description</label><input type="text" id="nc-desc" placeholder="About this channel"></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-do-newch">Create</button>
      <button class="btn sec" data-close="m-newch">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Channel -->
<div class="ov" id="m-editchannel">
  <div class="modal">
    <button class="modal-x" data-close="m-editchannel">‚úï</button>
    <h3>‚úèÔ∏è Edit Channel</h3>
    <div class="fr"><label>Name</label><input type="text" id="ec-name"></div>
    <div class="fr"><label>Description</label><input type="text" id="ec-desc"></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-save-editchannel">Save</button>
      <button class="btn sec" data-close="m-editchannel">Cancel</button>
    </div>
  </div>
</div>

<!-- Channel BG -->
<div class="ov" id="m-chbg">
  <div class="modal">
    <button class="modal-x" data-close="m-chbg">‚úï</button>
    <h3 id="chbg-title">üñºÔ∏è Channel Background</h3>
    <p style="font-size:12px;color:var(--dim);margin-bottom:12px" id="chbg-desc">Upload an image or GIF.</p>
    <div class="fr"><div class="upload-box" id="ub-chbg"><input type="file" accept="image/*,image/gif"><span class="ph">Click to upload</span></div></div>
    <div class="btn-row">
      <button class="btn pri" id="btn-save-chbg">Set</button>
      <button class="btn dan" id="btn-rm-chbg">Remove</button>
      <button class="btn sec" data-close="m-chbg">Cancel</button>
    </div>
  </div>
</div>

<!-- Members -->
<div class="ov" id="m-members">
  <div class="modal">
    <button class="modal-x" data-close="m-members">‚úï</button>
    <h3>üë• Members</h3>
    <div id="members-list"></div>
  </div>
</div>

<!-- Gallery Settings -->
<div class="ov" id="m-gallery-settings">
  <div class="modal" style="width:480px">
    <button class="modal-x" data-close="m-gallery-settings">‚úï</button>
    <h3><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVR4nO2UMQ7CMAxF38gNIrgOHYDTcAkWmHsVzsGCaFe4A6tRJSPSqjgJCVue5CWy/7edKFCeJXABjvyJFhCNU+nO98ACOKvBMMmIHfDwOhAjnkDjiXd6flCTVs9H5IqLxjDJLO+EWBxwnYj3wKqEgUsVJ2Et7hdxMnZ+8y50HWNg0RnijTaTZSBfxFFxKWXQz+w8WJ/6TKdUgyDVIEiwPva7FiPulsFWE3LEN+FBK3x4AdaaoWW8RUr6AAAAAElFTkSuQmCC" class="icon-img invert" style="vertical-align:middle;margin-right:8px" alt="">Gallery Settings</h3>
    <p style="font-size:12px;color:var(--dim);margin-bottom:14px">Customize your gallery's appearance. Changes preview live.</p>

    <div class="fr"><label>Page Background Image/GIF</label>
      <div class="upload-box" id="ub-gallery-bg"><input type="file" accept="image/*,image/gif"><span class="ph">Upload page background</span></div>
    </div>
    <div class="two">
      <div class="fr"><label>Page BG Color</label><input type="color" id="gal-bg" value="#0d1117"></div>
      <div class="fr"><label>Header/Controls</label><input type="color" id="gal-surf" value="#161b22"></div>
    </div>



    <h4 style="margin:18px 0 10px;font-size:13px;color:var(--text)">Accent Colors</h4>
    <div class="two">
      <div class="fr"><label>Accent Start</label><input type="color" id="gal-acc1" value="#58a6ff"></div>
      <div class="fr"><label>Accent End</label><input type="color" id="gal-acc2" value="#3fb950"></div>
    </div>
    <div class="grad-swatch" id="gal-grad-swatch" style="background:linear-gradient(135deg,#58a6ff,#3fb950)"></div>

    <h4 style="margin:18px 0 10px;font-size:13px;color:var(--text)">Other Colors</h4>
    <div class="two">
      <div class="fr"><label>Text Color</label><input type="color" id="gal-text" value="#c9d1d9"></div>
      <div class="fr"><label>Border Color</label><input type="color" id="gal-border" value="#30363d"></div>
    </div>

    <div class="btn-row">
      <button class="btn grad" id="btn-save-gallery-settings">Save</button>
      <button class="btn sec" id="btn-reset-gallery-settings">Reset</button>
      <button class="btn sec" data-close="m-gallery-settings">Cancel</button>
    </div>
  </div>
</div>

<!-- Gallery Page -->
<div id="gallery-page">
  <div id="gallery-bg"></div>
  <div id="gallery-header">
    <h2 id="gallery-owner-name">Gallery</h2>
    <div style="display:flex;gap:10px">
      <button class="btn sec" id="btn-gallery-settings">‚öôÔ∏è Settings</button>
      <button class="gal-close-btn" id="btn-close-gallery">‚úï Close</button>
    </div>
  </div>
   <div id="gallery-content">
    <div id="gallery-grid"></div>
    <div class="gallery-empty" id="gallery-empty" style="display:none">No items in gallery yet. Upload images or videos below!</div>
  </div>
  <div id="gallery-controls">
    <input type="file" id="gallery-upload" accept="image/*,video/*,image/gif" multiple style="display:none">
    <button class="btn grad" id="btn-gallery-upload" style="padding:10px 20px">üì§ Upload Media</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
//* ‚îÄ‚îÄ‚îÄ API CONNECTION ‚îÄ‚îÄ‚îÄ */
const API_URL = 'https://syntaxy-production-d83f.up.railway.app/api';

function getToken() {
  return localStorage.getItem('syntaxy_token');
}

function setToken(token) {
  localStorage.setItem('syntaxy_token', token);
}

function removeToken() {
  localStorage.removeItem('syntaxy_token');
}

async function api(endpoint, options = {}) {
  const token = getToken();

  const config = {
    method: options.method || 'GET',
    headers: {
      'Content-Type': 'application/json',
      ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
    }
  };

  if (options.body) {
    config.body = JSON.stringify(options.body);
  }

  const response = await fetch(`${API_URL}${endpoint}`, config);
  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error || 'API Error');
  }

  return data;
}

async function loadUserData() {
  try {
    // Load user's servers
    const servers = await api('/servers');

    // Clear existing servers except 'home'
    S.servers = S.servers.filter(s => s.id === 'home');

    // Add servers from database
    for (const srv of servers) {
      // Load channels for this server
      const channels = await api(`/servers/${srv.id}/channels`);

      S.servers.push({
        id: srv.id,
        name: srv.name,
        icon: srv.icon || srv.name[0],
        iconImg: srv.icon_img || '',
        banner: srv.banner || '',
        isAdmin: srv.owner_id === S.me.id,
        defChBg: srv.def_ch_bg || '',
        aesthetics: srv.aesthetics || {
          bg: '#0d1117',
          surface: '#161b22',
          acc1: srv.accent || '#58a6ff',
          acc2: '#3fb950',
          text: '#c9d1d9',
          border: '#30363d',
          sidebarStyle: 'solid',
          sidebarGrad1: '#161b22',
          sidebarGrad2: '#1c2333'
        },
        channels: channels.map(ch => ({
          id: ch.id,
          name: ch.name,
          desc: ch.description || '',
          type: 'ch',
          bg: ch.background || '',
          msgs: [] // Messages loaded when channel is opened
        })),
        dms: []
      });
    }

    // Set initial server/channel if we have servers
    if (S.servers.length > 1) {
      S.srvId = S.servers[1].id; // First real server (not 'home')
      S.chId = S.servers[1].channels[0]?.id;
      S.view = 'server';
    }
  } catch (err) {
    console.error('Failed to load user data:', err);
  }
}

async function loadDMsFromDatabase() {
  try {
    if (!getToken()) return;

    const dms = await api('/dms');
    const homeServer = S.servers.find(s => s.id === 'home');

    if (!homeServer) return;

    // Clear existing DMs
    homeServer.dms = [];

    // Add DMs from database
    for (const dm of dms) {
      const otherUserId = dm.user1_id === S.me.id ? dm.user2_id : dm.user1_id;
      const otherUsername = dm.user1_id === S.me.id ? dm.user2_username : dm.user1_username;
      const otherDisplayName = dm.user1_id === S.me.id ? dm.user2_display_name : dm.user1_display_name;

      homeServer.dms.push({
        id: dm.id,
        name: otherDisplayName || otherUsername,
        userId: otherUserId,
        type: 'dm',
        bg: dm.background || '',
        msgs: []
      });
      
      // Track last activity for sorting
      if (dm.last_message_at || dm.updated_at || dm.created_at) {
        S.dmLastActivity[dm.id] = dm.last_message_at || dm.updated_at || dm.created_at;
      }

    // Add/update user so U() has fresh data
      const otherAvatar = dm.user1_id === S.me.id ? dm.user2_avatar : dm.user1_avatar;
      const otherColor = dm.user1_id === S.me.id ? dm.user2_color : dm.user1_color;
      upsertUser({
        id: otherUserId,
        name: otherDisplayName || otherUsername,
        color: otherColor || '#58a6ff',
        avatar: otherAvatar || ''
      });
    }

    renderSidebar();
  } catch (err) {
    console.error('Failed to load DMs:', err);
  }
}

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
const S={
  me:{id:'me',name:'',color:'#58a6ff',accent:'#3fb950',bio:'',avatar:'',banner:'',gallery:{items:[],bg:'',bgColor:'#0d1117',surface:'#161b22',acc1:'#58a6ff',acc2:'#3fb950',text:'#c9d1d9',border:'#30363d'}},
  personalUI:{
    override:false,
    bg:'#0d1117',
    surface:'#161b22',
    acc1:'#58a6ff',
    acc2:'#3fb950',
    text:'#c9d1d9',
    border:'#30363d',
    sidebarStyle:'solid',
    sidebarGrad1:'#161b22',
    sidebarGrad2:'#1c2333'
  },
 users:[], // No more placeholder bots - all real users from database
 servers:[],
  srvId:null, chId:null,
  view:'dms', // 'server' | 'dms'
  replyTo:null, pendingImg:null, pendingChBg:null, ctxId:null, ctxChId:null,
  searchActive:false, editingChannelId:null, currentGalleryUserId:null,
  unreadDMs:{}, dmLastActivity:{}
};

/* ‚îÄ‚îÄ‚îÄ INDEXEDDB PERSISTENCE ‚îÄ‚îÄ‚îÄ */
const DB_NAME = 'syntaxy_db';
const DB_VERSION = 2;
const STORE_NAME = 'app_state';
let db = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };

    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains(STORE_NAME)) {
        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

// Compress image to reduce size
function compressImage(base64, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve) => {
    // Skip if not an image or if it's a GIF (preserve animation)
    if (!base64 || !base64.startsWith('data:image')) {
      resolve(base64);
      return;
    }

    // Don't compress GIFs - they lose animation
    if (base64.startsWith('data:image/gif')) {
      resolve(base64);
      return;
    }

    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;

      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = () => resolve(base64);
    img.src = base64;
  });
}

// Deep clone and compress images in object
async function prepareForSave(obj) {
  const clone = JSON.parse(JSON.stringify(obj));

  // Compress user avatars and banners
  if (clone.me) {
    if (clone.me.avatar) clone.me.avatar = await compressImage(clone.me.avatar, 400, 0.8);
    if (clone.me.banner) clone.me.banner = await compressImage(clone.me.banner, 800, 0.7);
    if (clone.me.gallery) {
      if (clone.me.gallery.bg) clone.me.gallery.bg = await compressImage(clone.me.gallery.bg, 1200, 0.6);
      if (clone.me.gallery.items) {
        for (let i = 0; i < clone.me.gallery.items.length; i++) {
          if (clone.me.gallery.items[i].type === 'image') {
            clone.me.gallery.items[i].src = await compressImage(clone.me.gallery.items[i].src, 800, 0.7);
          }
        }
      }
    }
  }

  // Compress other users
  if (clone.users) {
    for (const user of clone.users) {
      if (user.avatar) user.avatar = await compressImage(user.avatar, 400, 0.8);
      if (user.banner) user.banner = await compressImage(user.banner, 800, 0.7);
    }
  }

  // Compress server images and messages
  if (clone.servers) {
    for (const srv of clone.servers) {
      if (srv.iconImg) srv.iconImg = await compressImage(srv.iconImg, 200, 0.8);
      if (srv.banner) srv.banner = await compressImage(srv.banner, 800, 0.7);
      if (srv.defChBg) srv.defChBg = await compressImage(srv.defChBg, 1200, 0.6);

      // Compress channel backgrounds and message images
      if (srv.channels) {
        for (const ch of srv.channels) {
          if (ch.bg) ch.bg = await compressImage(ch.bg, 1200, 0.6);
          if (ch.msgs) {
            for (const msg of ch.msgs) {
              if (msg.img) msg.img = await compressImage(msg.img, 600, 0.7);
            }
          }
        }
      }

      // Compress DM backgrounds and message images
      if (srv.dms) {
        for (const dm of srv.dms) {
          if (dm.bg) dm.bg = await compressImage(dm.bg, 1200, 0.6);
          if (dm.msgs) {
            for (const msg of dm.msgs) {
              if (msg.img) msg.img = await compressImage(msg.img, 600, 0.7);
            }
          }
        }
      }
    }
  }

  return clone;
}

async function saveState() {
  if (!db) return;

  try {
    const prepared = await prepareForSave({
      me: S.me,
      personalUI: S.personalUI,
      users: S.users,
      servers: S.servers,
      srvId: S.srvId,
      chId: S.chId,
      view: S.view
    });

    const dataToSave = {
      id: 'main',
      ...prepared
    };

    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.put(dataToSave);

    tx.oncomplete = () => console.log('State saved successfully');
    tx.onerror = (e) => console.warn('Save error:', e);
  } catch(e) {
    console.warn('Failed to save state:', e);
  }
}

function loadState() {
  return new Promise((resolve) => {
    if (!db) {
      resolve(false);
      return;
    }

    try {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const request = store.get('main');

      request.onsuccess = () => {
        const data = request.result;
        if (data) {
          if (data.me) S.me = data.me;
          if (data.personalUI) S.personalUI = data.personalUI;
          if (data.users) S.users = data.users;
          if (data.servers && data.servers.length > 0) S.servers = data.servers;
          if (data.srvId) S.srvId = data.srvId;
          if (data.chId) S.chId = data.chId;
          if (data.view) S.view = data.view;

          // Ensure we have valid server/channel references
          if (!S.servers.find(s => s.id === S.srvId)) {
            S.srvId = S.servers[0]?.id || 'home';
          }
          const currentSrv = S.servers.find(s => s.id === S.srvId);
          if (currentSrv) {
            const allChannels = [...(currentSrv.channels || []), ...(currentSrv.dms || [])];
            if (!allChannels.find(c => c.id === S.chId) && allChannels.length > 0) {
              S.chId = allChannels[0].id;
            }
          }

          // Ensure all channels have msgs arrays
          S.servers.forEach(srv => {
            if(srv.channels) {
              srv.channels.forEach(ch => {
                if(!ch.msgs) ch.msgs = [];
              });
            }
            if(srv.dms) {
              srv.dms.forEach(dm => {
                if(!dm.msgs) dm.msgs = [];
              });
            }
          });

          console.log('State loaded successfully', {servers: S.servers.length, srvId: S.srvId, chId: S.chId});
          resolve(true);
        } else {
          resolve(false);
        }
      };

      request.onerror = () => {
        console.warn('Failed to load state');
        resolve(false);
      };
    } catch(e) {
      console.warn('Failed to load state:', e);
      resolve(false);
    }
  });
}

// Ensure all users have proper gallery structure
function ensureGalleryDefaults() {
  const defaultGallery = {
    items: [],
    bg: '',
    bgColor: '#0d1117',
    surface: '#161b22',
    acc1: '#58a6ff',
    acc2: '#3fb950',
    text: '#c9d1d9',
    border: '#30363d'
  };

  if (!S.me.gallery) S.me.gallery = {...defaultGallery};
  else S.me.gallery = {...defaultGallery, ...S.me.gallery};

  S.users.forEach(u => {
    if (!u.gallery) u.gallery = {...defaultGallery, acc1: u.color, acc2: u.accent};
    else u.gallery = {...defaultGallery, ...u.gallery};
  });
}

// Auto-save on changes (debounced)
let saveTimeout;
function autoSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveState, 1000);
}

// Sync settings (gallery + personalUI) to server database
let syncTimeout;
function syncSettingsToServer() {
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(async () => {
    try {
      if (!getToken()) return;
      await api('/users/settings', {
        method: 'PUT',
        body: {
          gallery: S.me.gallery,
          personal_ui: S.personalUI
        }
      });
      console.log('Settings synced to server');
    } catch(e) {
      console.warn('Failed to sync settings:', e);
    }
  }, 1500);
}

// Sync full profile to server database
async function syncProfileToServer() {
  try {
    if (!getToken()) return;
    await api('/users/profile', {
      method: 'PUT',
      body: {
        display_name: S.me.name,
        bio: S.me.bio,
        color: S.me.color,
        accent: S.me.accent,
        avatar: S.me.avatar,
        banner: S.me.banner,
        gallery: S.me.gallery,
        personal_ui: S.personalUI
      }
    });
    console.log('Profile synced to server');
    // Notify other users via WebSocket
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'profile_update',
        user: {
          id: S.me.id,
          display_name: S.me.name,
          color: S.me.color,
          accent: S.me.accent,
          avatar: S.me.avatar,
          banner: S.me.banner,
          bio: S.me.bio
        }
      }));
    }
  } catch(e) {
    console.warn('Failed to sync profile:', e);
  }
}

function updateProfilePreview() {
  const name = document.getElementById('p-name').value || S.me.name || 'User';
  const bio = document.getElementById('p-bio').value || '';
  const color = document.getElementById('p-color').value;
  const accent = document.getElementById('p-accent').value;
  const gradient = `linear-gradient(135deg, ${color}, ${accent})`;
  const primaryDark = darkenColor(color, 0.7);

  const card = document.getElementById('preview-profile-card');
  card.style.setProperty('--pc-primary', primaryDark);
  card.style.setProperty('--pc-accent-fade', `${accent}15`);
  card.style.background = primaryDark;
  card.style.border = `1px solid ${color}30`;

  const banner = document.getElementById('preview-pc-banner');
  const avatarFile = document.getElementById('ub-avatar').querySelector('input').files[0];
  const bannerFile = document.getElementById('ub-banner').querySelector('input').files[0];

  if(bannerFile) {
    readF(bannerFile).then(src => {
      banner.style.background = `url(${src}) center/cover`;
    });
  } else if(S.me.banner) {
    banner.style.background = `url(${S.me.banner}) center/cover`;
  } else {
    banner.style.background = gradient;
  }

  const avDiv = document.getElementById('preview-pc-av');
  if(avatarFile) {
    readF(avatarFile).then(src => {
      avDiv.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover;">`;
    });
  } else if(S.me.avatar) {
    avDiv.innerHTML = `<img src="${S.me.avatar}" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    avDiv.innerHTML = `<div class="default-av" style="width:100%;height:100%;background:${color};color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center">‚ú¶</div>`;
  }

  document.getElementById('preview-pc-name').textContent = name;
  document.getElementById('preview-pc-name').style.color = color;
  document.getElementById('preview-pc-bio').textContent = bio || 'No bio yet';

  // Update button gradient
  const btn = document.getElementById('preview-profile-btn');
  if(btn) btn.style.background = gradient;
}

// Initialize app
async function initApp() {
  // Show login screen immediately while loading
  const loginScreen = document.getElementById('login-screen');

  await openDB();
  const hasLoaded = await loadState();

  if (!hasLoaded) {
    // build DMs - create a special "home" server just for DMs
    S.servers.push({
      id: 'home', name: 'Home', icon: 'üè†', isAdmin: true,
      banner: '', defChBg: '', iconImg: '',
      aesthetics: {
  bg: '#0d1117',
  surface: '#161b22',
  acc1: '#58a6ff',
  acc2: '#3fb950',
  text: '#c9d1d9',
  border: '#30363d',
  sidebarStyle: 'solid',
  sidebarGrad1: '#161b22',
  sidebarGrad2: '#1c2333',
  sidebarOpacity:1,
  sidebarBlur:10
},
      channels: [],
      dms: []
    });
    S.users.forEach(u => S.servers[0].dms.push({ id: 'dm_' + u.id, name: u.name, userId: u.id, type: 'dm', bg: '', msgs: [] }));
    S.srvId = 'home';
    S.chId = 'dm_u1';

    // seed
    S.servers[0].dms[0].msgs = [
      { id: 10, uid: 'u1', text: 'hey!! check out the new theme engine', img: null, reply: null, time: T(), edited: false },
      { id: 11, uid: 'u1', text: 'I made my chat look like a sunset üåÖ', img: null, reply: null, time: T(), edited: false }
    ];
  }

  // Ensure gallery defaults
  ensureGalleryDefaults();

  // Check if user is logged in
  const isLoggedIn = S.me.name && S.me.name.trim() !== '';

  if (isLoggedIn) {
    loginScreen.style.display = 'none';
    await loadDMsFromDatabase();
    renderAll();
    initWebSocket();
  } else {
    loginScreen.style.display = 'flex';
    // Don't renderAll yet - wait for login
  }
}

// ADD THIS FUNCTION - it was referenced but never defined
document.getElementById('btn-profile').onclick=()=>{
  document.getElementById('p-name').value = S.me.name || '';
  document.getElementById('p-bio').value = S.me.bio || '';
  document.getElementById('p-color').value = S.me.color || '#58a6ff';
  document.getElementById('p-accent').value = S.me.accent || '#3fb950';
  const bioCounter = document.getElementById('bio-counter');
  if(bioCounter) bioCounter.textContent = `${(S.me.bio||'').length}/50`;
  const prev = document.getElementById('profile-grad-preview');
  if(prev) prev.style.background = `linear-gradient(135deg, ${S.me.color||'#58a6ff'}, ${S.me.accent||'#3fb950'})`;
  const avatarInput = document.getElementById('ub-avatar').querySelector('input');
  const bannerInput = document.getElementById('ub-banner').querySelector('input');
  if(avatarInput) avatarInput.value = '';
  if(bannerInput) bannerInput.value = '';

  openM('m-profile');
  openM('m-profile-preview');
  updateProfilePreview();
};

// Start the app
initApp();


function T(){return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}

/* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
// Cache for fetchFullUser - avoid repeated API calls
const _userFetchCache = {};
const USER_CACHE_TTL = 60000; // 60 seconds

async function fetchFullUser(uid) {
  const now = Date.now();
  const cached = U(uid);
  if (_userFetchCache[uid] && (now - _userFetchCache[uid] < USER_CACHE_TTL) && cached.name !== 'User') {
    return cached;
  }
  try {
    const data = await api(`/users/${uid}`);
    _userFetchCache[uid] = now;
    upsertUser({
      id: data.id,
      name: data.display_name || data.username,
      color: data.color,
      accent: data.accent,
      avatar: data.avatar,
      banner: data.banner,
      bio: data.bio,
      gallery: data.gallery || {}
    });
    return U(uid);
  } catch (err) {
    console.error('Failed to fetch user:', err);
    return cached;
  }
}

function upsertUser(userData) {
  if (!userData || userData.id === S.me.id) return;
  const existing = S.users.find(u => u.id === userData.id);
  if (existing) {
    existing.name = userData.name || existing.name;
    existing.color = userData.color || existing.color;
    existing.accent = userData.accent || existing.accent;
    existing.avatar = userData.avatar !== undefined ? userData.avatar : existing.avatar;
    existing.banner = userData.banner !== undefined ? userData.banner : existing.banner;
    existing.bio = userData.bio !== undefined ? userData.bio :
    existing.bio;
    if (userData.gallery) existing.gallery = userData.gallery;
  } else {
    S.users.push({
      id: userData.id,
      name: userData.name || 'User',
      color: userData.color || '#58a6ff',
      accent: userData.accent || '#3fb950',
      avatar: userData.avatar || '',
      banner: userData.banner || '',
      bio: userData.bio || '',
      gallery: userData.gallery || { items:[], bg:'', bgColor:'#0d1117', surface:'#161b22', acc1:'#58a6ff', acc2:'#3fb950', text:'#c9d1d9', border:'#30363d' }
    });
  }
}

function U(id) {
  if (id === 'me') return S.me;

  // Check local users first
  const localUser = S.users.find(u => u.id === id);
  if (localUser) return localUser;

  // For database user IDs, create a placeholder
  // The actual username comes from the message data
  return { name: 'User', color: '#58a6ff', avatar: '', banner: '', bio: '' };
}
function srv(){return S.servers.find(s=>s.id===S.srvId)}
function ch(){const s=srv();return s.channels.find(c=>c.id===S.chId)||s.dms.find(d=>d.id===S.chId)}
function readF(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(f)})}

// Upload file to S3 and return URL
async function uploadFileToS3(file) {
  const formData = new FormData();
  formData.append('file', file);
  const token = getToken();
  const resp = await fetch('/api/upload', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  });
  if (!resp.ok) throw new Error('Upload failed');
  const data = await resp.json();
  return data.url;
}
function linkify(t){return(t||'').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>')}
function avHTML(u,sz){
  sz=sz||34;
  if(u.avatar) return`<img src="${u.avatar}" style="width:${sz}px;height:${sz}px;object-fit:cover;">`;
  return`<div class="default-av" style="width:${sz}px;height:${sz}px;background:${u.color};color:#fff;font-size:${Math.round(sz*.5)}px">‚ú¶</div>`;
}
function darkenColor(hex, factor) {
  const r = Math.round(parseInt(hex.slice(1,3),16) * factor);
  const g = Math.round(parseInt(hex.slice(3,5),16) * factor);
  const b = Math.round(parseInt(hex.slice(5,7),16) * factor);
  return '#' + [r,g,b].map(v => Math.max(0,Math.min(255,v)).toString(16).padStart(2,'0')).join('');
}
function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ‚îÄ‚îÄ‚îÄ THEME ENGINE ‚îÄ‚îÄ‚îÄ */
function getCurrentTheme(){
  if(S.view === 'dms' || S.personalUI.override) {
    return S.personalUI;
  }
  return srv().aesthetics;
}

function lighten(hex,a){
  let r=parseInt(hex.slice(1,3),16)+a;
  let g=parseInt(hex.slice(3,5),16)+a;
  let b=parseInt(hex.slice(5,7),16)+a;
  return'#'+[r,g,b].map(v=>Math.min(255,Math.max(0,v)).toString(16).padStart(2,'0')).join('');
}

function applyTheme(t){
  const r=document.documentElement.style;
  r.setProperty('--bg',t.bg);
  r.setProperty('--surface',t.surface);
  r.setProperty('--surface2',lighten(t.surface,12));
  r.setProperty('--accent',t.acc1);
  r.setProperty('--accent2',t.acc2);
  r.setProperty('--text',t.text);
  r.setProperty('--border',t.border);
  r.setProperty('--grad',`linear-gradient(135deg,${t.acc1},${t.acc2})`);

  // Sidebar opacity and blur
  const sidebarOpacity = t.sidebarOpacity !== undefined ? t.sidebarOpacity : 1;
  const sidebarBlur = t.sidebarBlur !== undefined ? t.sidebarBlur : 10;
  const sidebarBgMode = t.sidebarBgMode || 'color';
  const sidebar = document.getElementById('channel-sidebar');
  const sidebarBgLayer = document.getElementById('sidebar-bg-layer');

  if(sidebar) {
    sidebar.style.backgroundColor = hexToRgba(t.surface, sidebarOpacity);
    r.setProperty('--sidebar-blur', sidebarBlur + 'px');
  }

  // Apply channel background to sidebar if in image mode
  if(sidebarBgLayer) {
    const c = ch();
    const channelBg = c ? (c.bg || srv().defChBg || '') : '';

    if(sidebarBgMode === 'image' && channelBg) {
      sidebarBgLayer.style.backgroundImage = `url(${channelBg})`;
      sidebarBgLayer.classList.add('show-image');
    } else {
      sidebarBgLayer.style.backgroundImage = '';
      sidebarBgLayer.classList.remove('show-image');
    }
  }

  // Sidebar gradient
  if(t.sidebarStyle === 'gradient') {
    const grad1 = hexToRgba(t.sidebarGrad1, sidebarOpacity);
    const grad2 = hexToRgba(t.sidebarGrad2, sidebarOpacity);
    r.setProperty('--sidebar-grad',`linear-gradient(180deg,${grad1},${grad2})`);
    document.getElementById('sidebar-body').classList.add('gradient-bg');
  } else {
    document.getElementById('sidebar-body').classList.remove('gradient-bg');
  }

  document.getElementById('btn-send').style.background=`linear-gradient(135deg,${t.acc1},${t.acc2})`;
}

/* ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ */
function renderRail(){
  const el=document.getElementById('server-rail'); el.innerHTML='';
  const tooltip = document.getElementById('rail-tooltip');

  function showTooltip(e, text) {
    const rect = e.target.closest('.rail-icon').getBoundingClientRect();
    tooltip.textContent = text;
    tooltip.style.left = (rect.right + 10) + 'px';
    tooltip.style.top = (rect.top + rect.height/2) + 'px';
    tooltip.style.opacity = '1';
  }

  function hideTooltip() {
    tooltip.style.opacity = '0';
  }

  // DM icon
  const dm=document.createElement('div');
  dm.className='rail-icon'+(S.view==='dms'?' active':'');
  dm.innerHTML='üí¨';
  dm.onclick=()=>{
    S.view='dms';
    S.srvId='home';
    const homeServer = S.servers.find(s => s.id === 'home');
    if(homeServer && homeServer.dms.length > 0) {
      S.chId = homeServer.dms[0].id;
    }
    renderAll();
    autoSave();
  };
  dm.onmouseenter = (e) => showTooltip(e, 'Direct Messages');
  dm.onmouseleave = hideTooltip;
  el.appendChild(dm);
  el.appendChild(Object.assign(document.createElement('div'),{className:'rail-divider'}));

  // servers (skip the 'home' server as it's just for DMs)
  S.servers.forEach(s=>{
    if(s.id === 'home') return;
    const i=document.createElement('div');
    i.className='rail-icon'+(S.view==='server'&&s.id===S.srvId?' active':'');
    i.innerHTML=s.iconImg?`<img src="${s.iconImg}">`:(s.icon||s.name[0]);
    i.onclick=()=>{S.view='server';S.srvId=s.id;S.chId=s.channels[0].id;renderAll();autoSave()};
    i.onmouseenter = (e) => showTooltip(e, s.name);
    i.onmouseleave = hideTooltip;

    // Drag-to-reorder
    i.draggable = true;
    i.dataset.srvId = s.id;
    i.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', s.id);
      i.style.opacity = '0.4';
      hideTooltip();
    });
    i.addEventListener('dragend', () => { i.style.opacity = '1'; });
    i.addEventListener('dragover', e => {
      e.preventDefault();
      i.style.borderTop = '2px solid var(--accent)';
    });
    i.addEventListener('dragleave', () => { i.style.borderTop = ''; });
    i.addEventListener('drop', e => {
      e.preventDefault();
      i.style.borderTop = '';
      const draggedId = isNaN(e.dataTransfer.getData('text/plain'))
        ? e.dataTransfer.getData('text/plain')
        : Number(e.dataTransfer.getData('text/plain'));
      const targetId = s.id;
      if (draggedId === targetId) return;
      const fromIdx = S.servers.findIndex(sv => sv.id === draggedId);
      const toIdx = S.servers.findIndex(sv => sv.id === targetId);
      if (fromIdx > -1 && toIdx > -1) {
        const [moved] = S.servers.splice(fromIdx, 1);
        S.servers.splice(toIdx, 0, moved);
        renderRail();
        autoSave();
      }
    });

    el.appendChild(i);
  });

  // add button
  const a=document.createElement('div');
  a.className='rail-icon';
  a.innerHTML='<span class="rail-add">+</span>';
  a.onclick=()=>openM('m-newsrv');
  a.onmouseenter = (e) => showTooltip(e, 'Create Server');
  a.onmouseleave = hideTooltip;
  el.appendChild(a);

  // join server button
  const j=document.createElement('div');
  j.className='rail-icon';
  j.innerHTML='<span class="rail-add" style="font-size:16px">üì©</span>';
  j.onclick=()=>{
    document.getElementById('join-invite-code').value='';
    document.getElementById('invite-preview').style.display='none';
    document.getElementById('invite-error').style.display='none';
    openM('m-joinsrv');
  };
  j.onmouseenter = (e) => showTooltip(e, 'Join Server');
  j.onmouseleave = hideTooltip;
  el.appendChild(j);
}

function renderSidebar(){
  const body=document.getElementById('sidebar-body'); body.innerHTML='';
  const s=srv();

  // Server banner
  const banner = document.getElementById('server-banner');
  if(S.view === 'server' && s && s.banner) {
    banner.style.backgroundImage = `url(${s.banner})`;
    banner.classList.add('visible');
  } else {
    banner.style.backgroundImage = '';
    banner.classList.remove('visible');
  }

  if(S.view==='dms'){
  document.getElementById('sidebar-title').textContent='Direct Messages';
  document.getElementById('btn-srv-set').style.display='none';
  document.getElementById('btn-friends').style.display='';
  updateFriendBadge();

  const homeServer = S.servers.find(srv => srv.id === 'home');
  const dmList = homeServer ? homeServer.dms : [];
  
  // Sort DMs by last activity (most recent first)
  dmList.sort((a, b) => {
    const tA = S.dmLastActivity[a.id] || '';
    const tB = S.dmLastActivity[b.id] || '';
    if (tA && tB) return new Date(tB) - new Date(tA);
    if (tA) return -1;
    if (tB) return 1;
    return 0;
  });
  // ADD SEARCH USERS BUTTON
  const searchBtn = document.createElement('button');
  searchBtn.id = 'open-user-search-btn';
  searchBtn.textContent = 'üîç Search Users';
  searchBtn.style.cssText = 'width:calc(100% - 16px);padding:10px;margin:8px;background:linear-gradient(135deg,#58a6ff,#3fb950);color:white;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:filter 0.2s;font-family:Inter,sans-serif';
  searchBtn.onclick = () => {
    document.getElementById('user-search-overlay').classList.add('show');
    document.getElementById('user-search-input').focus();
  };
  body.appendChild(searchBtn);

  // Show "No DMs yet" message if empty
  if (dmList.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.style.cssText = 'text-align:center;padding:40px 20px;color:var(--dim);font-size:13px;line-height:1.6';
    emptyMsg.innerHTML = `
      <div style="font-size:48px;margin-bottom:12px;opacity:0.3">üí¨</div>
      <div style="font-weight:600;margin-bottom:8px">No Direct Messages Yet</div>
      <div style="font-size:12px;opacity:0.8">Search for users above to start a conversation</div>
    `;
    body.appendChild(emptyMsg);
    return; // Don't try to render DM list
  }

  dmList.forEach(d=>{
    const u=U(d.userId);

    const el=document.createElement('div');
    const isUnread = S.unreadDMs[d.id];
    el.className='ch-item'+(d.id===S.chId?' active':'')+(isUnread?' dm-unread':'');
    el.innerHTML=`<div class="dm-av-sm">${avHTML(u,24)}</div><span class="ch-name">${u.name}</span>`;
    el.onclick=()=>{
      S.chId=d.id;
      delete S.unreadDMs[d.id];
      renderAll();
      autoSave();
    };
    body.appendChild(el);
  });
  } else {
    document.getElementById('sidebar-title').textContent=s.name;
    // channels
    // Show server settings button when not in DMs
  document.getElementById('btn-srv-set').style.display='flex';
  document.getElementById('btn-friends').style.display='none';
    const cl=document.createElement('div'); cl.className='sec-label';
    cl.innerHTML='CHANNELS <button id="btn-addch">+</button>'; body.appendChild(cl);
    document.getElementById('btn-addch').onclick=()=>openM('m-newch');
    s.channels.forEach(c=>{
      const el=document.createElement('div');
      el.className='ch-item'+(c.id===S.chId?' active':'');
      el.dataset.chid = c.id;
      el.innerHTML=`<span class="ch-icon">#</span><span class="ch-name">${c.name}</span>`;
      el.onclick=()=>{S.chId=c.id;renderAll();autoSave()};
      // Right-click context menu
      el.addEventListener('contextmenu', e => {
        e.preventDefault();
        e.stopPropagation();
        openChannelCtx(e, c.id);
      });
      body.appendChild(el);
    });
  }
}

function renderHeader(){
  const c=ch(); if(!c) return;
  const isDM=c.type==='dm';
  document.getElementById('hd-icon').textContent=isDM?'üí¨':'#';
  document.getElementById('hd-name').textContent=c.name;
  document.getElementById('hd-desc').textContent=isDM?`DM with ${c.name}`:(c.desc||'');
  document.getElementById('msg-input').placeholder=isDM?`Message ${c.name}‚Ä¶`:`Message #${c.name}‚Ä¶`;

  // Members button: servers only
  document.getElementById('btn-members').style.display = (S.view === 'server') ? '' : 'none';
  // Update friend request badge
  updateFriendBadge();
}

function renderBg(){
  const c=ch(); if(!c) return;
  const bg=c.bg||srv().defChBg||'';
  const layer=document.getElementById('bg-layer');
  if(bg){layer.style.backgroundImage=`url(${bg})`;layer.classList.add('has-img')}
  else{layer.style.backgroundImage='none';layer.classList.remove('has-img')}
}

let lastRenderedChId = null;
const _loadedChannels = new Set();

async function renderMsgs(){
  const c=ch(); if(!c) return;
  const wrap=document.getElementById('messages-wrap');

  // Load messages from API only if not already loaded
  if ((!_loadedChannels.has(c.id) || c.msgs.length === 0) && typeof c.id === 'number') {
    _loadedChannels.add(c.id);
    try {
      const endpoint = c.type === 'dm'
        ? `/dms/${c.id}/messages`
        : `/channels/${c.id}/messages`;

      const messages = await api(endpoint);
    // Add/update message authors with latest data
      messages.forEach(m => {
        upsertUser({
          id: m.user_id,
          name: m.display_name || m.username,
          color: m.color,
          accent: m.accent,
          avatar: m.avatar
        });
      });
      c.msgs = messages.map(m => ({
        id: m.id,
        uid: m.user_id === S.me.id ? 'me' : m.user_id,
        text: m.text || '',
        img: m.image || null,
        reply: m.reply_to,
        time: new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
        edited: m.edited,
        reactions: m.reactions || {},
        username: m.username,
        userColor: m.color || '#58a6ff'
      }));
    } catch (err) {
      console.error('Failed to load messages:', err);
      _loadedChannels.delete(c.id);
    }
  }

 // If we switched channels, clear everything and do full render
  if(lastRenderedChId !== S.chId) {
    wrap.innerHTML = '';
    lastRenderedChId = S.chId;

    // Clear unread for this channel
    if (c.type === 'dm') {
      delete S.unreadDMs[c.id];
      renderSidebar();
    }

    if(c.msgs && c.msgs.length > 0) {
      let lastDateLabel = null;
      c.msgs.forEach((m, i) => {
        // Date divider
        const dateLabel = getMsgDateLabel(m.rawTime);
        if (dateLabel && dateLabel !== lastDateLabel) {
          const divider = document.createElement('div');
          divider.className = 'msg-date-divider';
          divider.textContent = dateLabel;
          wrap.appendChild(divider);
          lastDateLabel = dateLabel;
        }
        const prev = i > 0 ? c.msgs[i-1] : null;
        const row = createMsgRow(m, prev);
        wrap.appendChild(row);
      });
    }
    wrap.scrollTop = wrap.scrollHeight;
    return;
  }

  // Same channel - only add new messages
  const existingIds = new Set(
    Array.from(wrap.querySelectorAll('.msg-row[data-id]'))
      .map(el => el.dataset.id).filter(Boolean)
  );

  const newMessages = c.msgs.filter(m => !existingIds.has(String(m.id)));

  // Append only new messages with animation
  newMessages.forEach(m => {
    // Find previous message for grouping
    const mIdx = c.msgs.indexOf(m);
    const prev = mIdx > 0 ? c.msgs[mIdx - 1] : null;

    // Date divider if needed
    const dateLabel = getMsgDateLabel(m.rawTime);
    if (dateLabel) {
      const lastDivider = wrap.querySelector('.msg-date-divider:last-of-type');
      if (!lastDivider || lastDivider.textContent !== dateLabel) {
        const divider = document.createElement('div');
        divider.className = 'msg-date-divider';
        divider.textContent = dateLabel;
        wrap.appendChild(divider);
      }
    }

    const row = createMsgRow(m, prev);
    row.style.opacity = '0';
    row.style.transform = 'translateY(20px)';
    wrap.appendChild(row);

    requestAnimationFrame(() => {
      row.style.opacity = '1';
      row.style.transform = 'translateY(0)';
    });
  });

  // Auto-scroll if user is near bottom
  if(wrap.scrollHeight - wrap.scrollTop - wrap.clientHeight < 150) {
    wrap.scrollTop = wrap.scrollHeight;
  }
}

function createMsgRow(m) {
  const c = ch();
  const isMe = m.uid === 'me';
  const u = U(m.uid);

  if(m.sys) {
    const d = document.createElement('div');
    d.className = 'sys-msg';
    d.textContent = m.text;
    return d;
  }

  let rpHTML = '';
  if(m.reply) {
    const rm = c.msgs.find(x => x.id === m.reply);
    if(rm && !rm.sys) {
      const ru = U(rm.uid);
      rpHTML = `<div class="reply-pre" data-scroll="${rm.id}">‚Ü© <strong>${ru.name}</strong> ${(rm.text||'').substring(0,40)}${(rm.text||'').length > 40 ? '‚Ä¶' : ''}</div>`;
    }
  }

  // Build reactions HTML
  let reactHTML = '';
  if(m.reactions && Object.keys(m.reactions).length > 0) {
    reactHTML = '<div class="msg-reactions">';
    for(const emoji in m.reactions) {
      const users = m.reactions[emoji];
      const isMine = users.includes('me');
      reactHTML += `<div class="msg-react${isMine ? ' mine' : ''}" data-emoji="${emoji}" data-msgid="${m.id}">
        <span>${emoji}</span>
        <span class="msg-react-count">${users.length}</span>
      </div>`;
    }
    reactHTML += '</div>';
  }

  const row = document.createElement('div');
  row.className = 'msg-row';
  row.dataset.id = m.id;
  row.dataset.uid = m.uid;
  row.innerHTML = `
    <div class="msg-av" data-uid="${m.uid}">${avHTML(u,34)}</div>
    <div class="msg-body">
      ${rpHTML}
      <div class="msg-hd">
        <span class="msg-name" style="color:${u.color}" data-uid="${m.uid}">${u.name}</span>
        <span class="msg-time">${m.time}</span>
        ${m.edited ? '<span class="msg-edited">(edited)</span>' : ''}
      </div>
      <div class="msg-text">${linkify(m.text)}</div>
      ${m.img ? `<img class="msg-img" src="${m.img}" alt="">` : ''}
      ${reactHTML}
    </div>`;

  // RIGHT-CLICK ‚Üí context menu
  row.addEventListener('contextmenu', e => {
    e.preventDefault();
    openCtx(e, m.id, isMe);
  });

  return row;
}

function renderAll(){
  const theme = getCurrentTheme();
  applyTheme(theme);
  renderRail();
  renderSidebar();
  renderHeader();
  renderBg();
  renderMsgs();
}

/* ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-search').onclick = toggleSearch;
document.getElementById('search-window-close').onclick = toggleSearch;
document.addEventListener('keydown', e => {
  if(e.ctrlKey && e.key.toLowerCase() === 'f') {
    e.preventDefault();
    toggleSearch();
  }
  if(e.key === 'Escape' && S.searchActive) {
    toggleSearch();
  }
});

function toggleSearch() {
  S.searchActive = !S.searchActive;
  const win = document.getElementById('search-window');
  const input = document.getElementById('search-window-input');

  if(S.searchActive) {
    win.classList.add('show');
    input.focus();
  } else {
    win.classList.remove('show');
    input.value = '';
    document.getElementById('search-results-area').innerHTML = '';
  }
}

document.getElementById('search-window-input').addEventListener('input', e => {
  const query = e.target.value.toLowerCase().trim();
  const c = ch();
  const resultsArea = document.getElementById('search-results-area');

  if(!c) return;

  if(!query) {
    resultsArea.innerHTML = '';
    return;
  }

  const matches = c.msgs.filter(m =>
    !m.sys && m.text && m.text.toLowerCase().includes(query)
  );

  if(matches.length === 0) {
    resultsArea.innerHTML = '<div class="search-no-results">No messages found</div>';
    return;
  }

  resultsArea.innerHTML = '';
  matches.forEach(m => {
    const u = U(m.uid);
    const item = document.createElement('div');
    item.className = 'search-result-item';

    // Highlight the query in the text
    const text = m.text.replace(
      new RegExp(`(${query})`, 'gi'),
      '<mark>$1</mark>'
    );

    item.innerHTML = `
      <div class="search-result-user" style="color:${u.color}">${u.name} <span style="color:var(--dim);font-weight:400;font-size:11px">${m.time}</span></div>
      <div class="search-result-text">${text}</div>
    `;

    item.onclick = () => {
      const msgRow = document.querySelector(`.msg-row[data-id="${m.id}"]`);
      if(msgRow) {
        msgRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        msgRow.classList.add('highlight');
        setTimeout(() => msgRow.classList.remove('highlight'), 2000);
      }
      toggleSearch();
    };

    resultsArea.appendChild(item);
  });
});

/* ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ */
function openCtx(e,id,isMe){
  S.ctxId=id;
  const m=document.getElementById('ctx-menu');
  document.getElementById('ctx-edit').style.display=isMe?'flex':'none';
  document.getElementById('ctx-delete').style.display=isMe?'flex':'none';
  document.getElementById('ctx-sep').style.display=isMe?'block':'none';
  m.style.display='block';
  let x=e.clientX,y=e.clientY;
  // keep in viewport
  requestAnimationFrame(()=>{
    const mw=m.offsetWidth,mh=m.offsetHeight;
    if(x+mw>window.innerWidth)x=window.innerWidth-mw-8;
    if(y+mh>window.innerHeight)y=window.innerHeight-mh-8;
    m.style.left=x+'px';m.style.top=y+'px';
  });
}
function closeCtx(){
  document.getElementById('ctx-menu').style.display='none';
  S.ctxId=null;
}

function openChannelCtx(e, chId) {
  S.ctxChId = chId;
  const m = document.getElementById('ctx-channel');
  m.style.display = 'block';
  let x = e.clientX, y = e.clientY;

  requestAnimationFrame(() => {
    const mw = m.offsetWidth, mh = m.offsetHeight;
    if(x + mw > window.innerWidth) x = window.innerWidth - mw - 8;
    if(y + mh > window.innerHeight) y = window.innerHeight - mh - 8;
    m.style.left = x + 'px';
    m.style.top = y + 'px';
  });
}

function closeChannelCtx() {
  document.getElementById('ctx-channel').style.display = 'none';
  S.ctxChId = null;
}

document.getElementById('ctx-reply').onclick =()=>{if(S.ctxId!==null)startReply(S.ctxId);closeCtx()};
document.getElementById('ctx-copy').onclick  =()=>{
  if(S.ctxId!==null){
    const c=ch();const m=c.msgs.find(x=>x.id===S.ctxId);
    if(m&&m.text)navigator.clipboard.writeText(m.text);
  }
  closeCtx();
};
document.getElementById('ctx-edit').onclick  =()=>{if(S.ctxId!==null)editMsg(S.ctxId);closeCtx()};
document.getElementById('ctx-delete').onclick=()=>{if(S.ctxId!==null)deleteMsg(S.ctxId);closeCtx()};
document.getElementById('ctx-react').onclick =()=>{if(S.ctxId!==null)reactToMsg(S.ctxId);closeCtx()};

document.getElementById('ctx-ch-edit').onclick = () => {
  if(S.ctxChId) {
    const c = srv().channels.find(ch => ch.id === S.ctxChId);
    if(c) {
      S.editingChannelId = S.ctxChId;
      document.getElementById('ec-name').value = c.name;
      document.getElementById('ec-desc').value = c.desc;
      openM('m-editchannel');
    }
  }
  closeChannelCtx();
};

document.getElementById('ctx-ch-delete').onclick = () => {
  if(S.ctxChId && confirm('Delete this channel?')) {
    const s = srv();
    const idx = s.channels.findIndex(c => c.id === S.ctxChId);
    if(idx > -1) {
      s.channels.splice(idx, 1);
      if(S.chId === S.ctxChId) {
        S.chId = s.channels[0].id;
      }
      renderAll();
      autoSave();
    }
  }
  closeChannelCtx();
};

document.addEventListener('click',(e)=>{
  if(!e.target.closest('#ctx-menu'))closeCtx();
  if(!e.target.closest('#ctx-channel'))closeChannelCtx();
});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCtx();closeChannelCtx();closePC()}});

/* ‚îÄ‚îÄ‚îÄ PROFILE CARD ‚îÄ‚îÄ‚îÄ */
async function showPC(e,uid){
  e.stopPropagation();

  // Close any open modals (like members list)
  document.querySelectorAll('.ov.show').forEach(m => m.classList.remove('show'));

  // Parse string IDs to numbers (dataset attributes are always strings)
  if (uid !== 'me' && !isNaN(uid)) uid = Number(uid);

  const u=U(uid);
  const card=document.getElementById('profile-card');

  // Get user's colors (with fallbacks)
  const primary = u.color || '#58a6ff';
  const secondary = u.accent || '#3fb950';
  const gradient = `linear-gradient(135deg, ${primary}, ${secondary})`;

  // Darken the primary color for background
  const primaryDark = darkenColor(primary, 0.7);
  const primaryMid = darkenColor(primary, 0.5);

  // Set CSS custom properties for this user's theme
  card.style.setProperty('--pc-primary', primaryDark);
  card.style.setProperty('--pc-accent-fade', `${secondary}15`);
  card.style.setProperty('--pc-accent-glow', `${primary}12`);
  card.style.setProperty('--pc-secondary-glow', `${secondary}10`);
  card.style.background = primaryDark;
  card.style.border = `1px solid ${primary}30`;

  // Banner - use gradient if no image
  const banner = document.getElementById('pc-banner');
  if(u.banner) {
    banner.style.background = `url(${u.banner}) center/cover`;
  } else {
    banner.style.background = gradient;
  }

  document.getElementById('pc-av').innerHTML=avHTML(u,76);
  document.getElementById('pc-name').textContent=u.name;
  document.getElementById('pc-name').style.color=primary;
  document.getElementById('pc-bio').textContent=u.bio||'No bio yet';

  // Friend badge - managed by async status check below
  const friendBadge = document.getElementById('pc-friend');
  friendBadge.style.display='none';
  friendBadge.style.background = `${secondary}22`;
  friendBadge.style.color = secondary;

  // actions
  const act=document.getElementById('pc-actions');
  act.innerHTML='';

  if(uid === 'me') {
    // Edit Profile button for own profile
    const editB = document.createElement('button');
    editB.className = 'pc-btn pri';
    editB.style.background = gradient;
    editB.innerHTML = '‚úèÔ∏è Edit';
    editB.onclick = () => {
      closePC();
      document.getElementById('btn-profile').click();
    };
    act.appendChild(editB);

    // Gallery button
    const galB = document.createElement('button');
    galB.className = 'pc-btn gallery';
    galB.style.background = gradient;
    galB.innerHTML = 'üñºÔ∏è Gallery';
    galB.onclick = () => {
      closePC();
      openGallery('me');
    };
    act.appendChild(galB);
 } else {
    // DM btn
    const dmB=document.createElement('button');
    dmB.className='pc-btn sec';
    dmB.innerHTML='üí¨ DM';
    dmB.onclick=()=>{
      const homeServer = S.servers.find(s => s.id === 'home');
      if(homeServer) {
        const d = homeServer.dms.find(x => x.userId === uid);
        if(d) {
          closePC();
          S.srvId = 'home';
          S.chId = d.id;
          S.view = 'dms';
          renderAll();
        }
      }
    };
    act.appendChild(dmB);

    // Friend btn - check real friendship status from API
    const frB=document.createElement('button');
    frB.className='pc-btn pend';
    frB.innerHTML='‚è≥ Loading...';
    frB.disabled=true;
    act.appendChild(frB);

    // Async check friendship status
    if (typeof uid === 'number') {
      (async () => {
        try {
          const statusData = await api(`/friends/status/${uid}`);
          if (statusData.status === 'accepted') {
            frB.className='pc-btn pend';
            frB.innerHTML='‚úì Friends';
            frB.disabled=true;
            // Also show the friend badge
            friendBadge.style.display='inline';
          } else if (statusData.status === 'pending_sent') {
            frB.className='pc-btn pend';
            frB.innerHTML='‚è≥ Pending';
            frB.disabled=true;
            friendBadge.style.display='none';
          } else if (statusData.status === 'pending_received') {
            frB.className='pc-btn pri';
            frB.style.background = gradient;
            frB.innerHTML='‚úì Accept';
            frB.disabled=false;
            frB.onclick=async()=>{
              frB.disabled=true;
              frB.innerHTML='Accepting...';
              await acceptFriendRequest(statusData.requestId, frB);
              frB.className='pc-btn pend';
              frB.innerHTML='‚úì Friends';
              friendBadge.style.display='inline';
              updateFriendBadge();
            };
            friendBadge.style.display='none';
          } else {
            frB.className='pc-btn pri';
            frB.style.background = gradient;
            frB.innerHTML='+ Add';
            frB.disabled=false;
            frB.onclick=async()=>{
              frB.disabled=true;
              frB.innerHTML='Sending...';
              try {
                await sendFriendRequest(uid, frB);
                frB.className='pc-btn pend';
                frB.innerHTML='‚è≥ Pending';
              } catch(err) {
                frB.innerHTML='+ Add';
                frB.disabled=false;
              }
            };
            friendBadge.style.display='none';
          }
        } catch(err) {
          frB.className='pc-btn pri';
          frB.style.background = gradient;
          frB.innerHTML='+ Add';
          frB.disabled=false;
          friendBadge.style.display='none';
        }
      })();
    }

    // Gallery button for other users
    const galB = document.createElement('button');
    galB.className = 'pc-btn gallery';
    galB.style.background = gradient;
    galB.innerHTML = 'üñºÔ∏è Gallery';
    galB.onclick = () => {
      closePC();
      openGallery(uid);
    };
    act.appendChild(galB);
  }

  // position
  card.style.display='block';
  const rect=e.target.getBoundingClientRect();
  requestAnimationFrame(()=>{
    let l=rect.left+rect.width+10, t=rect.top;
    const cw=card.offsetWidth,cht=card.offsetHeight;
    if(l+cw>window.innerWidth)l=rect.left-cw-10;
    if(t+cht>window.innerHeight)t=window.innerHeight-cht-10;
    if(t<0)t=10;
    card.style.left=l+'px';card.style.top=t+'px';
  });

  // Background refresh for other users
  if (uid !== 'me' && typeof uid === 'number') {
    fetchFullUser(uid).then(freshU => {
      if (card.style.display === 'block') {
        document.getElementById('pc-av').innerHTML = avHTML(freshU, 76);
        document.getElementById('pc-name').textContent = freshU.name;
        document.getElementById('pc-name').style.color = freshU.color || '#58a6ff';
        document.getElementById('pc-bio').textContent = freshU.bio || 'No bio yet';
        if (freshU.banner) document.getElementById('pc-banner').style.background = `url(${freshU.banner}) center/cover`;
      }
    });
  }
}

function updatePC(uid){
  const u=U(uid);
  // Friend badge is now managed by the async status check in showPC
}

function closePC(){document.getElementById('profile-card').style.display='none'}

// delegated clicks for avatars & names in chat
document.getElementById('messages-wrap').addEventListener('click',e=>{
  const av=e.target.closest('.msg-av[data-uid]');
  if(av){showPC(e,av.dataset.uid);return}
  const nm=e.target.closest('.msg-name[data-uid]');
  if(nm){showPC(e,nm.dataset.uid);return}
  const rp=e.target.closest('.reply-pre[data-scroll]');
  if(rp){const t=document.querySelector(`[data-id="${rp.dataset.scroll}"]`);if(t)t.scrollIntoView({behavior:'smooth',block:'center'});return}

  // Handle reaction click (toggle)
  const react=e.target.closest('.msg-react[data-msgid]');
  if(react){
    const msgId=Number(react.dataset.msgid);
    const emoji=react.dataset.emoji;
    const c=ch();
    const m=c.msgs.find(x=>x.id===msgId);
    if(m && m.reactions && m.reactions[emoji]){
      const idx=m.reactions[emoji].indexOf('me');
      if(idx>-1){
        m.reactions[emoji].splice(idx,1);
        if(m.reactions[emoji].length===0) delete m.reactions[emoji];
      } else {
        m.reactions[emoji].push('me');
      }
      // Update just this message row
      const row=document.querySelector(`.msg-row[data-id="${msgId}"]`);
      if(row){
        const newRow=createMsgRow(m);
        row.replaceWith(newRow);
      }
    }
    return;
  }
});

// close card on outside click
document.addEventListener('click',e=>{
  if(!e.target.closest('#profile-card')&&!e.target.closest('.msg-av')&&!e.target.closest('.msg-name')&&!e.target.closest('.mem-av')&&!e.target.closest('.mem-name'))closePC();
});

/* ‚îÄ‚îÄ‚îÄ MESSAGING ‚îÄ‚îÄ‚îÄ */
async function send() {
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  const c = ch();
  if (!c) return;
  if (!text && !S.pendingImg) return;

  // Clear input immediately
  inp.value = '';
  const tempImg = S.pendingImg;
  const tempReply = S.replyTo;
  S.pendingImg = null;
  cancelReply();
  document.getElementById('btn-attach').classList.remove('has');

  // Determine if this is a DM - handle both string IDs (old) and numeric IDs (database)
  const isDM = c.type === 'dm';
  const channelId = isDM ? null : c.id;

  // For DMs, use the numeric ID if it exists, otherwise don't send
  const dmChannelId = isDM ? (typeof c.id === 'number' ? c.id : null) : null;

  if (isDM && !dmChannelId) {
    console.error('Cannot send DM - not a database DM channel');
    return;
  }

  // If it's a real channel (from database), send via WebSocket
  if (c.type === 'ch' && typeof c.id === 'number') {
    // Send via WebSocket
    sendMessageViaWebSocket(channelId, text, tempImg, tempReply, false, null);
  } else if (isDM) {
    // For DMs, send via WebSocket if available
    sendMessageViaWebSocket(null, text, tempImg, tempReply, true, dmChannelId);
  } else {
    // Local-only (demo channels)
    c.msgs.push({
      id: Date.now(),
      uid: 'me',
      text,
      img: tempImg,
      reply: tempReply,
      time: T(),
      edited: false,
      reactions: {}
    });
    renderMsgs();
  }

  autoSave();
}

// Wire up send button and input
document.getElementById('btn-send').onclick = () => send();
document.getElementById('msg-input').addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

document.getElementById('btn-attach').onclick = () => document.getElementById('file-input').click();
document.getElementById('file-input').onchange = async e => {
  const f = e.target.files[0];
  if(!f) return;
  S.pendingImg = await readF(f);
  e.target.value = '';
  document.getElementById('btn-attach').classList.add('has');
};

function startReply(id){
  S.replyTo=id;
  const c=ch(); const m=c.msgs.find(x=>x.id===id); if(!m) return;
  document.getElementById('reply-label').textContent=`Replying to ${U(m.uid).name}: ${(m.text||'').substring(0,40)}`;
  document.getElementById('reply-bar').classList.add('show');
}

function cancelReply(){
  S.replyTo=null;
  document.getElementById('reply-bar').classList.remove('show');
}

document.getElementById('btn-cancel-reply').onclick=cancelReply;

function editMsg(id){
  const c=ch();const m=c.msgs.find(x=>x.id===id);if(!m)return;
  const t=prompt('Edit:',m.text);
  if(t!==null&&t.trim()){
    m.text=t.trim();
    m.edited=true;
    const row = document.querySelector(`.msg-row[data-id="${id}"]`);
    if(row) {
      const newRow = createMsgRow(m);
      row.replaceWith(newRow);
    }
    // Persist edit via WebSocket
    if(typeof id === 'number') {
      const isDM = c.type === 'dm';
      editMessageViaWebSocket(id, m.text, isDM, isDM ? null : c.id, isDM ? c.id : null);
    }
    autoSave();
  }
}

function reactToMsg(id){
  const emojis=['üëç','‚ù§Ô∏è','üòÇ','üî•','üòÆ','üéâ','üíØ','üò¢'];
  const c=ch();const m=c.msgs.find(x=>x.id===id);if(!m)return;
  const pick=prompt('React with emoji:\n'+emojis.join(' ')+'\n\nOr type any emoji:');
  if(!pick||!pick.trim())return;
  const emoji=pick.trim();
  if(!m.reactions)m.reactions={};
  if(!m.reactions[emoji])m.reactions[emoji]=[];
  const idx=m.reactions[emoji].indexOf('me');
  if(idx>-1){m.reactions[emoji].splice(idx,1);if(m.reactions[emoji].length===0)delete m.reactions[emoji];}
  else{m.reactions[emoji].push('me');}
  const row=document.querySelector(`.msg-row[data-id="${id}"]`);
  if(row){const newRow=createMsgRow(m);row.replaceWith(newRow);}
  autoSave();
}

/* ‚îÄ‚îÄ‚îÄ MODAL SYSTEM ‚îÄ‚îÄ‚îÄ */
function openM(id){
  document.getElementById(id).classList.add('show');
}

function closeM(id){
  document.getElementById(id).classList.remove('show');
}

// Wire all modal close buttons (X buttons and Cancel buttons with data-close)
document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.onclick=()=>{
    const modalId = btn.dataset.close;
    closeM(modalId);
    if(btn.dataset.close === 'm-profile') closeM('m-profile-preview'); // ADD THIS
    if(modalId === 'm-profile') closeM('m-profile-preview');
    if(modalId === 'm-ui') closeM('m-ui-preview');
    if(modalId === 'm-srv') closeM('m-srv-preview');
  };
});

/* ‚îÄ‚îÄ‚îÄ UPLOAD PREVIEW ‚îÄ‚îÄ‚îÄ */
function setPreview(boxId, src){
  const box=document.getElementById(boxId);
  if(!box) return;
  const ph=box.querySelector('.ph');
  const existing=box.querySelector('img');
  if(existing) existing.remove();
  if(src){
    const img=document.createElement('img');
    img.src=src;
    box.appendChild(img);
    if(ph) ph.style.display='none';
  } else {
    if(ph) ph.style.display='';
  }
}

/* ‚îÄ‚îÄ‚îÄ DELETE MESSAGE ‚îÄ‚îÄ‚îÄ */
function deleteMsg(id){
  if(!confirm('Delete this message?')) return;
  const c=ch();
  const idx=c.msgs.findIndex(m=>m.id===id);
  if(idx>-1){
    if(typeof id === 'number'){
      api(`/messages/${id}`,{method:'DELETE'}).catch(err=>console.error('Delete failed:',err));
    }
    c.msgs.splice(idx,1);
    const row=document.querySelector(`.msg-row[data-id="${id}"]`);
    if(row) row.remove();
    autoSave();
  }
}

/* ‚îÄ‚îÄ‚îÄ EDIT CHANNEL SAVE ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-save-editchannel').onclick=async()=>{
  if(!S.editingChannelId) return;
  const s=srv();
  const c=s.channels.find(ch=>ch.id===S.editingChannelId);
  if(!c) return;
  const newName=document.getElementById('ec-name').value.trim();
  const newDesc=document.getElementById('ec-desc').value.trim();
  if(newName) c.name=newName;
  c.desc=newDesc;
  if(typeof c.id==='number'){
    try{
      await api(`/servers/${S.srvId}/channels/${c.id}`,{
        method:'PUT',
        body:{name:c.name,description:c.desc}
      });
    }catch(err){console.error('Edit channel failed:',err)}
  }
  S.editingChannelId=null;
  closeM('m-editchannel');
  renderAll();
  autoSave();
};

// Replace existing listeners with:
document.getElementById('p-bio').addEventListener('input', () => {
  const bio = document.getElementById('p-bio').value;
  const counter = document.getElementById('bio-counter');
  if(counter) counter.textContent = `${bio.length}/50`;
  updateProfilePreview(); // ADD THIS
});

['p-color','p-accent'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    const c = document.getElementById('p-color').value;
    const a = document.getElementById('p-accent').value;
    const prev = document.getElementById('profile-grad-preview');
    if(prev) prev.style.background = `linear-gradient(135deg, ${c}, ${a})`;
    updateProfilePreview(); // ADD THIS
  });
});

// ADD THIS NEW LISTENER for name changes
document.getElementById('p-name').addEventListener('input', updateProfilePreview);

// ADD THIS NEW LISTENER for avatar/banner uploads
['ub-avatar', 'ub-banner'].forEach(id => {
  document.getElementById(id).querySelector('input').addEventListener('change', updateProfilePreview);
});

document.getElementById('btn-save-prof').onclick = async ()=>{
  S.me.name = document.getElementById('p-name').value.trim() || S.me.name;
  S.me.bio = document.getElementById('p-bio').value.trim();
  S.me.color = document.getElementById('p-color').value;
  S.me.accent = document.getElementById('p-accent').value;

  const af = document.getElementById('ub-avatar').querySelector('input').files[0];
  if(af) S.me.avatar = await readF(af);

  const bf = document.getElementById('ub-banner').querySelector('input').files[0];
  if(bf) S.me.banner = await readF(bf);

  closeM('m-profile');
  closeM('m-profile-preview');
  renderAll();
  autoSave();
  syncProfileToServer();
};

// Live updates for profile modal
document.getElementById('p-bio').addEventListener('input', () => {
  const bio = document.getElementById('p-bio').value;
  const counter = document.getElementById('bio-counter');
  if(counter) counter.textContent = `${bio.length}/50`;
});

['p-color','p-accent'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    const c = document.getElementById('p-color').value;
    const a = document.getElementById('p-accent').value;
    const prev = document.getElementById('profile-grad-preview');
    if(prev) prev.style.background = `linear-gradient(135deg, ${c}, ${a})`;
  });
});

/* ‚îÄ‚îÄ‚îÄ UI SETTINGS ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-ui').onclick=openUISettings;

function openUISettings(){
  const t=S.personalUI;
  document.getElementById('ui-override').checked = t.override;
  document.getElementById('ui-bg').value    =t.bg;
  document.getElementById('ui-surf').value  =t.surface;
  document.getElementById('ui-acc1').value  =t.acc1;
  document.getElementById('ui-acc2').value  =t.acc2;
  document.getElementById('ui-text').value  =t.text;
  document.getElementById('ui-border').value=t.border;
  document.getElementById('ui-sidebar-style').value=t.sidebarStyle;
  document.getElementById('ui-sb-grad1').value=t.sidebarGrad1;
  document.getElementById('ui-sb-grad2').value=t.sidebarGrad2;

  const opacity = t.sidebarOpacity !== undefined ? t.sidebarOpacity : 1;
  const blur = t.sidebarBlur !== undefined ? t.sidebarBlur : 10;
  document.getElementById('ui-sidebar-opacity').value = opacity * 100;
  document.getElementById('ui-sidebar-blur').value = blur;
  document.getElementById('ui-opacity-val').textContent = Math.round(opacity * 100) + '%';
  document.getElementById('ui-blur-val').textContent = blur + 'px';
  const bgMode = t.sidebarBgMode || 'color';
document.getElementById('ui-sidebar-bg-mode').value = bgMode;

  document.getElementById('ui-grad-swatch').style.background=`linear-gradient(135deg,${t.acc1},${t.acc2})`;
  document.getElementById('ui-sidebar-grad-swatch').style.background=`linear-gradient(135deg,${t.sidebarGrad1},${t.sidebarGrad2})`;

  toggleUISidebarGradControls();
  openM('m-ui');
  openM('m-ui-preview');
  updateUIPreview();
}

function updateUIPreview() {
  const bg = document.getElementById('ui-bg').value;
  const surf = document.getElementById('ui-surf').value;
  const acc1 = document.getElementById('ui-acc1').value;
  const acc2 = document.getElementById('ui-acc2').value;
  const text = document.getElementById('ui-text').value;
  const border = document.getElementById('ui-border').value;
  const sidebarStyle = document.getElementById('ui-sidebar-style').value;
  const sbGrad1 = document.getElementById('ui-sb-grad1').value;
  const sbGrad2 = document.getElementById('ui-sb-grad2').value;
  const opacity = document.getElementById('ui-sidebar-opacity').value / 100;
  const blur = document.getElementById('ui-sidebar-blur').value;

  const sample = document.getElementById('preview-ui-sample');
  const sidebar = document.getElementById('preview-ui-sidebar');
  const main = document.getElementById('preview-ui-main');
  const header = document.getElementById('preview-ui-header');
  const content = document.getElementById('preview-ui-content');
  const input = document.getElementById('preview-ui-input');
  const avatar = document.getElementById('preview-ui-avatar');

  // Apply colors
  sample.style.background = bg;
  sample.style.color = text;
  sample.style.borderColor = border;

  if(sidebarStyle === 'gradient') {
    const grad1 = hexToRgba(sbGrad1, opacity);
    const grad2 = hexToRgba(sbGrad2, opacity);
    sidebar.style.background = `linear-gradient(180deg, ${grad1}, ${grad2})`;
  } else {
    sidebar.style.backgroundColor = hexToRgba(surf, opacity);
  }
  sidebar.style.backdropFilter = `blur(${blur}px)`;
  sidebar.style.webkitBackdropFilter = `blur(${blur}px)`;
  sidebar.style.color = text;

  main.style.background = bg;
  main.style.color = text;

  header.style.background = `rgba(${hexToRgb(surf)}, 0.8)`;
  header.style.borderBottomColor = border;
  header.style.color = text;

  content.style.color = text;

  input.style.background = `rgba(${hexToRgb(surf)}, 0.8)`;
  input.style.borderTopColor = border;
  input.querySelector('div').style.background = surf;
  input.querySelector('div').style.borderColor = border;
  input.querySelector('div').style.color = text;

  avatar.style.background = `linear-gradient(135deg, ${acc1}, ${acc2})`;
}

function toggleUISidebarGradControls() {
  const style = document.getElementById('ui-sidebar-style').value;
  const controls = document.getElementById('ui-sidebar-grad-controls');
  controls.style.display = style === 'gradient' ? 'block' : 'none';
}

document.getElementById('ui-sidebar-style').addEventListener('change', toggleUISidebarGradControls);

// live updates
['ui-bg','ui-surf','ui-acc1','ui-acc2','ui-text','ui-border'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    S.personalUI.bg     =document.getElementById('ui-bg').value;
    S.personalUI.surface=document.getElementById('ui-surf').value;
    S.personalUI.acc1   =document.getElementById('ui-acc1').value;
    S.personalUI.acc2   =document.getElementById('ui-acc2').value;
    S.personalUI.text   =document.getElementById('ui-text').value;
    S.personalUI.border =document.getElementById('ui-border').value;
    if(S.view === 'dms' || S.personalUI.override) {
      applyTheme(S.personalUI);
    }
    document.getElementById('ui-grad-swatch').style.background=`linear-gradient(135deg,${S.personalUI.acc1},${S.personalUI.acc2})`;
    updateUIPreview();
  });
});

['ui-sb-grad1','ui-sb-grad2'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    S.personalUI.sidebarGrad1 = document.getElementById('ui-sb-grad1').value;
    S.personalUI.sidebarGrad2 = document.getElementById('ui-sb-grad2').value;
    document.getElementById('ui-sidebar-grad-swatch').style.background=`linear-gradient(135deg,${S.personalUI.sidebarGrad1},${S.personalUI.sidebarGrad2})`;
    if((S.view === 'dms' || S.personalUI.override) && S.personalUI.sidebarStyle === 'gradient') {
      applyTheme(S.personalUI);
    }
    updateUIPreview();
  });
});

document.getElementById('ui-sidebar-opacity').addEventListener('input', (e) => {
  const val = e.target.value / 100;
  S.personalUI.sidebarOpacity = val;
  document.getElementById('ui-opacity-val').textContent = Math.round(val * 100) + '%';
  if(S.view === 'dms' || S.personalUI.override) {
    applyTheme(S.personalUI);
  }
  updateUIPreview();
});

document.getElementById('ui-sidebar-blur').addEventListener('input', (e) => {
  const val = e.target.value;
  S.personalUI.sidebarBlur = Number(val);
  document.getElementById('ui-blur-val').textContent = val + 'px';
  if(S.view === 'dms' || S.personalUI.override) {
    applyTheme(S.personalUI);
  }
  updateUIPreview();
});

document.getElementById('ui-sidebar-bg-mode').addEventListener('change', (e) => {
  S.personalUI.sidebarBgMode = e.target.value;
  if(S.view === 'dms' || S.personalUI.override) {
    applyTheme(S.personalUI);
  }
  updateUIPreview();
});

document.getElementById('btn-save-ui').onclick=()=>{
  S.personalUI.override = document.getElementById('ui-override').checked;
  S.personalUI.sidebarStyle = document.getElementById('ui-sidebar-style').value;
  closeM('m-ui');
  closeM('m-ui-preview');
  renderAll();
  autoSave();
  syncSettingsToServer();
};

document.getElementById('btn-reset-ui').onclick=()=>{
  S.personalUI={
    override:false,
    bg:'#0d1117',
    surface:'#161b22',
    acc1:'#58a6ff',
    acc2:'#3fb950',
    text:'#c9d1d9',
    border:'#30363d',
    sidebarStyle:'solid',
    sidebarGrad1:'#161b22',
    sidebarGrad2:'#1c2333',
    sidebarOpacity:1,
    sidebarBlur:10,
    sidebarBgMode:'color'
  };
  renderAll();
  openUISettings();
  updateUIPreview();
  autoSave();
  syncSettingsToServer();
};

/* ‚îÄ‚îÄ‚îÄ SERVER SETTINGS ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-srv-set').onclick=()=>{
  const s=srv();if(!s.isAdmin)return;
  const a = s.aesthetics;

  document.getElementById('s-name').value  =s.name;
  document.getElementById('s-bg').value    =a.bg;
  document.getElementById('s-surf').value  =a.surface;
  document.getElementById('s-acc1').value  =a.acc1;
  document.getElementById('s-acc2').value  =a.acc2;
  document.getElementById('s-text').value  =a.text;
  document.getElementById('s-border').value=a.border;
  document.getElementById('s-sidebar-style').value=a.sidebarStyle;
document.getElementById('s-sb-grad1').value=a.sidebarGrad1;
document.getElementById('s-sb-grad2').value=a.sidebarGrad2;

const sOpacity = a.sidebarOpacity !== undefined ? a.sidebarOpacity : 1;
const sBlur = a.sidebarBlur !== undefined ? a.sidebarBlur : 10;
const sBgMode = a.sidebarBgMode || 'color';

document.getElementById('s-sidebar-opacity').value = sOpacity * 100;
document.getElementById('s-sidebar-blur').value = sBlur;
document.getElementById('s-sidebar-bg-mode').value = sBgMode;
document.getElementById('s-opacity-val').textContent = Math.round(sOpacity * 100) + '%';
document.getElementById('s-blur-val').textContent = sBlur + 'px';

document.getElementById('s-grad-swatch').style.background=`linear-gradient(135deg,${a.acc1},${a.acc2})`;
  document.getElementById('s-sidebar-grad-swatch').style.background=`linear-gradient(135deg,${a.sidebarGrad1},${a.sidebarGrad2})`;

  setPreview('ub-srv-icon',s.iconImg||'');
  setPreview('ub-srv-ban',s.banner||'');
  setPreview('ub-srv-chbg',s.defChBg||'');

  toggleServerSidebarGradControls();
  openM('m-srv');
  openM('m-srv-preview');
  updateServerPreview();
};

function toggleServerSidebarGradControls() {
  const style = document.getElementById('s-sidebar-style').value;
  const controls = document.getElementById('s-sidebar-grad-controls');
  controls.style.display = style === 'gradient' ? 'block' : 'none';
}

document.getElementById('s-sidebar-style').addEventListener('change', toggleServerSidebarGradControls);

// ADD name listener:
document.getElementById('s-name').addEventListener('input', updateServerPreview);

// live updates for server aesthetics
['s-bg','s-surf','s-acc1','s-acc2','s-text','s-border'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const s = srv();
    s.aesthetics.bg     =document.getElementById('s-bg').value;
    s.aesthetics.surface=document.getElementById('s-surf').value;
    s.aesthetics.acc1   =document.getElementById('s-acc1').value;
    s.aesthetics.acc2   =document.getElementById('s-acc2').value;
    s.aesthetics.text   =document.getElementById('s-text').value;
    s.aesthetics.border =document.getElementById('s-border').value;
    if(S.view === 'server' && !S.personalUI.override) {
      applyTheme(s.aesthetics);
    }
    document.getElementById('s-grad-swatch').style.background=`linear-gradient(135deg,${s.aesthetics.acc1},${s.aesthetics.acc2})`;
    updateServerPreview();
  });
});

['s-sb-grad1','s-sb-grad2'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const s = srv();
    s.aesthetics.sidebarGrad1 = document.getElementById('s-sb-grad1').value;
    s.aesthetics.sidebarGrad2 = document.getElementById('s-sb-grad2').value;
    document.getElementById('s-sidebar-grad-swatch').style.background=`linear-gradient(135deg,${s.aesthetics.sidebarGrad1},${s.aesthetics.sidebarGrad2})`;
    if(S.view === 'server' && !S.personalUI.override && s.aesthetics.sidebarStyle === 'gradient') {
      applyTheme(s.aesthetics);
    }
    updateServerPreview();
  });
});

document.getElementById('s-sidebar-opacity').addEventListener('input', (e) => {
  const val = e.target.value / 100;
  srv().aesthetics.sidebarOpacity = val;
  document.getElementById('s-opacity-val').textContent = Math.round(val * 100) + '%';
  if(S.view === 'server' && !S.personalUI.override) {
    applyTheme(srv().aesthetics);
  }
  updateServerPreview();
});

document.getElementById('s-sidebar-blur').addEventListener('input', (e) => {
  const val = e.target.value;
  srv().aesthetics.sidebarBlur = Number(val);
  document.getElementById('s-blur-val').textContent = val + 'px';
  if(S.view === 'server' && !S.personalUI.override) {
    applyTheme(srv().aesthetics);
  }
  updateServerPreview();
});

document.getElementById('s-sidebar-bg-mode').addEventListener('change', (e) => {
  srv().aesthetics.sidebarBgMode = e.target.value;
  if(S.view === 'server' && !S.personalUI.override) {
    applyTheme(srv().aesthetics);
  }
  updateServerPreview();
});

// ADD sidebar style listener:
document.getElementById('s-sidebar-style').addEventListener('change', () => {
  toggleServerSidebarGradControls();
  updateServerPreview();
});

// ADD file upload listeners:
['ub-srv-icon', 'ub-srv-ban', 'ub-srv-chbg'].forEach(id => {
  document.getElementById(id).querySelector('input').addEventListener('change', updateServerPreview);
});

document.getElementById('btn-save-srv').onclick=async()=>{
  const s=srv();
  s.name  =document.getElementById('s-name').value.trim()||s.name;
  s.aesthetics.sidebarStyle = document.getElementById('s-sidebar-style').value;
  s.aesthetics.sidebarOpacity = document.getElementById('s-sidebar-opacity').value / 100;
  s.aesthetics.sidebarBlur = Number(document.getElementById('s-sidebar-blur').value);
  s.aesthetics.sidebarBgMode = document.getElementById('s-sidebar-bg-mode').value;

  const iF=document.getElementById('ub-srv-icon').querySelector('input').files[0];
  if(iF) {
    try { s.iconImg = await uploadFileToS3(iF); } catch(e) { s.iconImg = await readF(iF); }
  }
  const bF=document.getElementById('ub-srv-ban').querySelector('input').files[0];
  if(bF) {
    try { s.banner = await uploadFileToS3(bF); } catch(e) { s.banner = await readF(bF); }
  }
  const cF=document.getElementById('ub-srv-chbg').querySelector('input').files[0];
  if(cF) {
    try { s.defChBg = await uploadFileToS3(cF); } catch(e) { s.defChBg = await readF(cF); }
  }

  // Broadcast to all members via WebSocket
  if(ws && ws.readyState === WebSocket.OPEN && typeof s.id === 'number') {
    ws.send(JSON.stringify({
      type:'server_aesthetics_update',
      serverId: s.id,
      aesthetics: s.aesthetics,
      name: s.name,
      iconImg: s.iconImg,
      banner: s.banner,
      defChBg: s.defChBg
    }));
  }

  closeM('m-srv');
  closeM('m-srv-preview');
  renderAll();
  autoSave();
};

function updateServerPreview() {
  const s = srv();
  if(!s) return;

  const name = document.getElementById('s-name').value;
  const bg = document.getElementById('s-bg').value;
  const surf = document.getElementById('s-surf').value;
  const acc1 = document.getElementById('s-acc1').value;
  const acc2 = document.getElementById('s-acc2').value;
  const text = document.getElementById('s-text').value;
  const border = document.getElementById('s-border').value;
  const sidebarStyle = document.getElementById('s-sidebar-style').value;
  const sbGrad1 = document.getElementById('s-sb-grad1').value;
  const sbGrad2 = document.getElementById('s-sb-grad2').value;

  // Rail icon preview
  const railIcon = document.getElementById('preview-srv-rail-icon');
  const iconFile = document.getElementById('ub-srv-icon').querySelector('input').files[0];
  if(iconFile) {
    readF(iconFile).then(src => {
      railIcon.innerHTML = `<img src="${src}">`;
    });
  } else if(s.iconImg) {
    railIcon.innerHTML = `<img src="${s.iconImg}">`;
  } else {
    railIcon.innerHTML = s.icon || name[0];
  }
  railIcon.style.borderColor = acc1;

  // Banner preview
  const banner = document.getElementById('preview-srv-banner');
  const bannerFile = document.getElementById('ub-srv-ban').querySelector('input').files[0];
  if(bannerFile) {
    readF(bannerFile).then(src => {
      banner.style.backgroundImage = `url(${src})`;
      banner.style.display = 'block';
    });
  } else if(s.banner) {
    banner.style.backgroundImage = `url(${s.banner})`;
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }

  // Title
  document.getElementById('preview-srv-title').textContent = name;
  document.getElementById('preview-srv-title').style.color = text;

  // Sidebar
 // Sidebar
const sidebar = document.getElementById('preview-srv-sidebar');
const sOpacity = document.getElementById('s-sidebar-opacity').value / 100;
const sBlur = document.getElementById('s-sidebar-blur').value;

if(sidebarStyle === 'gradient') {
  const grad1 = hexToRgba(sbGrad1, sOpacity);
  const grad2 = hexToRgba(sbGrad2, sOpacity);
  sidebar.style.background = `linear-gradient(180deg, ${grad1}, ${grad2})`;
} else {
  sidebar.style.backgroundColor = hexToRgba(surf, sOpacity);
}
sidebar.style.backdropFilter = `blur(${sBlur}px)`;
sidebar.style.webkitBackdropFilter = `blur(${sBlur}px)`;
sidebar.style.color = text;

  // Main area
  const main = document.getElementById('preview-srv-main');
  main.style.background = bg;
  main.style.color = text;

  // Channel background
  const bgLayer = document.getElementById('preview-srv-bg');
  const chBgFile = document.getElementById('ub-srv-chbg').querySelector('input').files[0];
  if(chBgFile) {
    readF(chBgFile).then(src => {
      bgLayer.style.backgroundImage = `url(${src})`;
      bgLayer.style.opacity = '0.4';
    });
  } else if(s.defChBg) {
    bgLayer.style.backgroundImage = `url(${s.defChBg})`;
    bgLayer.style.opacity = '0.4';
  } else {
    bgLayer.style.backgroundImage = 'none';
  }

  // Header, content, input
  document.getElementById('preview-srv-header').style.borderBottomColor = border;
  document.getElementById('preview-srv-header').style.color = text;
  document.getElementById('preview-srv-content').style.color = text;
  document.getElementById('preview-srv-input').style.borderTopColor = border;
  document.getElementById('preview-srv-input').querySelector('div').style.background = surf;
  document.getElementById('preview-srv-input').querySelector('div').style.borderColor = border;
  document.getElementById('preview-srv-input').querySelector('div').style.color = text;

  // Avatar gradient
  document.getElementById('preview-srv-avatar').style.background = `linear-gradient(135deg, ${acc1}, ${acc2})`;
}

/* ‚îÄ‚îÄ‚îÄ CREATE SERVER ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-do-newsrv').onclick = async () => {
  const name = document.getElementById('ns-name').value.trim();
  if (!name) return;

  try {
    // Create server via API
    const newServer = await api('/servers', {
      method: 'POST',
      body: { name }
    });

    // Load the new server's channels
    const channels = await api(`/servers/${newServer.id}/channels`);

    const s = {
      id: newServer.id,
      name: newServer.name,
      icon: newServer.name[0],
      isAdmin: true,
      banner: '',
      defChBg: '',
      iconImg: '',
      aesthetics: {
  bg: '#0d1117',
  surface: '#161b22',
  acc1: document.getElementById('ns-accent').value,
  acc2: '#3fb950',
  text: '#c9d1d9',
  border: '#30363d',
  sidebarStyle: 'solid',
  sidebarGrad1: '#161b22',
  sidebarGrad2: '#1c2333',
  sidebarOpacity:1,
  sidebarBlur:10
},
      channels: channels.map(ch => ({
        id: ch.id,
        name: ch.name,
        desc: ch.description || '',
        type: 'ch',
        bg: '',
        msgs: []
      })),
      dms: []
    };

    S.servers.push(s);
    S.srvId = s.id;
    S.chId = s.channels[0]?.id;
    S.view = 'server';

    document.getElementById('ns-name').value = '';
    closeM('m-newsrv');
    renderAll();
  } catch (err) {
    alert('Failed to create server: ' + err.message);
  }
};

/* ‚îÄ‚îÄ‚îÄ SERVER INVITES ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-invite-srv').onclick=async()=>{
  const s=srv();
  if(!s || typeof s.id !== 'number') return;
  try {
    const invite = await api(`/servers/${s.id}/invites`, { method:'POST' });
    document.getElementById('invite-code-display').value = invite.code;
    document.getElementById('invite-copied-msg').style.display = 'none';
    closeM('m-srv');
    closeM('m-srv-preview');
    openM('m-invite');
  } catch(err) {
    alert('Failed to create invite: ' + err.message);
  }
};

document.getElementById('btn-new-invite').onclick=async()=>{
  const s=srv();
  if(!s || typeof s.id !== 'number') return;
  try {
    const invite = await api(`/servers/${s.id}/invites`, { method:'POST' });
    document.getElementById('invite-code-display').value = invite.code;
    document.getElementById('invite-copied-msg').style.display = 'none';
  } catch(err) {
    alert('Failed to create invite: ' + err.message);
  }
};

document.getElementById('btn-copy-invite').onclick=()=>{
  const code = document.getElementById('invite-code-display').value;
  navigator.clipboard.writeText(code).then(()=>{
    document.getElementById('invite-copied-msg').style.display = 'block';
    setTimeout(()=>{ document.getElementById('invite-copied-msg').style.display = 'none'; }, 2000);
  });
};

// Join server - lookup invite code
let _joinInviteTimeout = null;
document.getElementById('join-invite-code').addEventListener('input', (e) => {
  clearTimeout(_joinInviteTimeout);
  const code = e.target.value.trim();
  document.getElementById('invite-preview').style.display = 'none';
  document.getElementById('invite-error').style.display = 'none';
  if(code.length < 4) return;
  _joinInviteTimeout = setTimeout(async()=>{
    try {
      const info = await api(`/invites/${code}`);
      document.getElementById('invite-srv-name').textContent = info.server_name;
      document.getElementById('invite-srv-members').textContent = `${info.member_count} members`;
      const iconEl = document.getElementById('invite-srv-icon');
      if(info.icon_img) {
        iconEl.innerHTML = `<img src="${info.icon_img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px">`;
      } else {
        iconEl.textContent = info.server_name[0];
      }
      if(info.already_member) {
        document.getElementById('invite-error').textContent = 'You are already a member of this server';
        document.getElementById('invite-error').style.display = 'block';
      }
      document.getElementById('invite-preview').style.display = 'block';
    } catch(err) {
      document.getElementById('invite-error').textContent = 'Invalid invite code';
      document.getElementById('invite-error').style.display = 'block';
    }
  }, 400);
});

document.getElementById('btn-do-joinsrv').onclick=async()=>{
  const code = document.getElementById('join-invite-code').value.trim();
  if(!code) return;
  try {
    const result = await api(`/invites/${code}/join`, { method:'POST' });
    const srv = result.server;
    const channels = result.channels;

    S.servers.push({
      id: srv.id,
      name: srv.name,
      icon: srv.icon || srv.name[0],
      iconImg: srv.icon_img || '',
      banner: srv.banner || '',
      isAdmin: false,
      defChBg: srv.def_ch_bg || '',
      aesthetics: srv.aesthetics || {
        bg:'#0d1117', surface:'#161b22', acc1:'#58a6ff', acc2:'#3fb950',
        text:'#c9d1d9', border:'#30363d', sidebarStyle:'solid',
        sidebarGrad1:'#161b22', sidebarGrad2:'#1c2333'
      },
      channels: channels.map(ch => ({
        id: ch.id, name: ch.name, desc: ch.description || '',
        type:'ch', bg: ch.background || '', msgs:[]
      })),
      dms: []
    });

    S.srvId = srv.id;
    S.chId = channels[0]?.id;
    S.view = 'server';
    closeM('m-joinsrv');
    renderAll();
  } catch(err) {
    document.getElementById('invite-error').textContent = err.message || 'Failed to join server';
    document.getElementById('invite-error').style.display = 'block';
  }
};



/* ‚îÄ‚îÄ‚îÄ EDIT CHANNEL ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-do-newch').onclick = async () => {
  const name = document.getElementById('nc-name').value.trim().replace(/\s+/g, '-').toLowerCase();
  if (!name) return;

  try {
    const newChannel = await api(`/servers/${S.srvId}/channels`, {
      method: 'POST',
      body: {
        name,
        description: document.getElementById('nc-desc').value
      }
    });

    srv().channels.push({
      id: newChannel.id,
      name: newChannel.name,
      desc: newChannel.description || '',
      type: 'ch',
      bg: '',
      msgs: []
    });

    document.getElementById('nc-name').value = '';
    document.getElementById('nc-desc').value = '';
    closeM('m-newch');
    renderSidebar();
  } catch (err) {
    alert('Failed to create channel: ' + err.message);
  }
};

/* ‚îÄ‚îÄ‚îÄ CHANNEL BG ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-chbg').onclick=()=>{
  const c=ch();if(!c)return;
  document.getElementById('chbg-title').textContent=c.type==='dm'?'üñºÔ∏è DM Background':'üñºÔ∏è Channel Background';
  document.getElementById('chbg-desc').textContent=c.type==='dm'?'Set a shared background. Both users can change it.':'Set a custom background for this channel.';
  setPreview('ub-chbg',c.bg||'');S.pendingChBg=null;S.pendingChBgFile=null;
  openM('m-chbg');
};
document.getElementById('ub-chbg').querySelector('input').onchange=async function(e){
  const f=e.target.files[0];if(!f)return;
  S.pendingChBgFile=f;
  S.pendingChBg=await readF(f);setPreview('ub-chbg',S.pendingChBg);
};
document.getElementById('btn-save-chbg').onclick=async()=>{
  const c=ch();if(!c)return;
  let bgUrl = S.pendingChBg || '';

  if(S.pendingChBgFile) {
    try {
      bgUrl = await uploadFileToS3(S.pendingChBgFile);
    } catch(err) {
      console.warn('S3 upload failed, using base64:', err);
    }
  }

  if(!bgUrl) { S.pendingChBg=null;S.pendingChBgFile=null;closeM('m-chbg');return; }

  c.bg = bgUrl;

  if(c.type === 'dm' && ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type:'dm_bg_change', dmChannelId:c.id, background:bgUrl }));
  } else if(c.type !== 'dm' && ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type:'channel_bg_change', channelId:c.id, background:bgUrl }));
  }

  S.pendingChBg=null;S.pendingChBgFile=null;closeM('m-chbg');renderBg();autoSave();
};
document.getElementById('btn-rm-chbg').onclick=()=>{
  const c=ch();if(!c)return;
  c.bg='';

  if(c.type === 'dm' && ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type:'dm_bg_change', dmChannelId:c.id, background:'' }));
  } else if(c.type !== 'dm' && ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type:'channel_bg_change', channelId:c.id, background:'' }));
  }
  S.pendingChBg=null;S.pendingChBgFile=null;closeM('m-chbg');renderBg();autoSave();
};

/* ‚îÄ‚îÄ‚îÄ MEMBERS ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-members').onclick=async()=>{
  const list=document.getElementById('members-list');list.innerHTML='';

  if(S.view === 'server' && typeof S.srvId === 'number') {
    // Fetch actual server members from API
    try {
      const members = await api(`/servers/${S.srvId}/members`);
      members.forEach(m => {
        const isMe = m.user_id === S.me.id;
        upsertUser({
          id: m.user_id,
          name: m.display_name || m.username,
          color: m.color,
          accent: m.accent,
          avatar: m.avatar
        });
        list.innerHTML += memRow(isMe ? 'me' : m.user_id, isMe);
      });
    } catch(err) {
      console.error('Failed to load members:', err);
      list.innerHTML += memRow('me', true);
    }
  } else {
    list.innerHTML+=memRow('me',true);
    S.users.forEach(u=>list.innerHTML+=memRow(u.id,false));
  }

  openM('m-members');
  requestAnimationFrame(()=>{
    document.querySelectorAll('.mem-av[data-uid]').forEach(el=>el.addEventListener('click',e=>showPC(e,el.dataset.uid)));
    document.querySelectorAll('.mem-name[data-uid]').forEach(el=>el.addEventListener('click',e=>showPC(e,el.dataset.uid)));
  });
};
function memRow(uid,isMe){
  const u=U(uid);
  const avContent = u.avatar
    ? `<img src="${u.avatar}" style="width:34px;height:34px;object-fit:cover;">`
    : `<div class="default-av" style="background:${u.color};color:#fff;width:34px;height:34px">‚ú¶</div>`;
  const avW=`<div class="mem-av"${isMe?'':`data-uid="${uid}"`}>${avContent}</div>`;
  const nameW=`<span class="mem-name"${isMe?'':`data-uid="${uid}"`} style="color:${u.color}">${u.name}</span>`;
  const tag=isMe?'<span class="tag" style="margin-left:auto">You</span>':(u.friends?'<span class="tag" style="margin-left:auto;background:rgba(63,185,80,.12);color:var(--accent2)">Friend</span>':'');
  return`<div class="mem-row">${avW}${nameW}${tag}</div>`;
}

/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ‚îÄ LOGIN/REGISTER SYSTEM ‚îÄ‚îÄ‚îÄ */
let isLoginMode = true;

// Tab switching
document.getElementById('tab-login').onclick = () => {
  isLoginMode = true;
  document.getElementById('tab-login').classList.add('active');
  document.getElementById('tab-register').classList.remove('active');
  document.getElementById('login-password-confirm').style.display = 'none';
  document.getElementById('login-btn').textContent = 'Login';
  hideLoginMessages();
};

document.getElementById('tab-register').onclick = () => {
  isLoginMode = false;
  document.getElementById('tab-register').classList.add('active');
  document.getElementById('tab-login').classList.remove('active');
  document.getElementById('login-password-confirm').style.display = 'block';
  document.getElementById('login-btn').textContent = 'Create Account';
  hideLoginMessages();
};

function hideLoginMessages() {
  document.getElementById('login-error').classList.remove('show');
  document.getElementById('login-success').classList.remove('show');
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = msg;
  el.classList.add('show');
  document.getElementById('login-success').classList.remove('show');
}

function showLoginSuccess(msg) {
  const el = document.getElementById('login-success');
  el.textContent = msg;
  el.classList.add('show');
  document.getElementById('login-error').classList.remove('show');
}

// Get stored users
function getStoredUsers() {
  try {
    return JSON.parse(localStorage.getItem('syntaxy_users') || '{}');
  } catch {
    return {};
  }
}

function saveStoredUsers(users) {
  localStorage.setItem('syntaxy_users', JSON.stringify(users));
}

// Simple hash function for password (not cryptographically secure, just for demo)
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(16);
}

document.getElementById('login-btn').onclick = handleAuth;
document.getElementById('login-username').addEventListener('keydown', e => { if(e.key === 'Enter') document.getElementById('login-password').focus(); });
document.getElementById('login-password').addEventListener('keydown', e => {
  if(e.key === 'Enter') {
    if(isLoginMode) handleAuth();
    else document.getElementById('login-password-confirm').focus();
  }
});
document.getElementById('login-password-confirm').addEventListener('keydown', e => { if(e.key === 'Enter') handleAuth(); });

async function handleAuth() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const passwordConfirm = document.getElementById('login-password-confirm').value;

  hideLoginMessages();

  if (!username) {
    showLoginError('Please enter a username');
    return;
  }

  if (username.length < 3) {
    showLoginError('Username must be at least 3 characters');
    return;
  }

  if (!password) {
    showLoginError('Please enter a password');
    return;
  }

  if (password.length < 4) {
    showLoginError('Password must be at least 4 characters');
    return;
  }

  try {
    if (isLoginMode) {
      // LOGIN
      const data = await api('/auth/login', {
        method: 'POST',
        body: { username, password }
      });

      setToken(data.token);

      const defaultGallery = {
        items:[], bg:'', bgColor:'#0d1117', surface:'#161b22',
        acc1:'#58a6ff', acc2:'#3fb950', text:'#c9d1d9', border:'#30363d'
      };
      const defaultUI = {
        override:false, bg:'#0d1117', surface:'#161b22', acc1:'#58a6ff',
        acc2:'#3fb950', text:'#c9d1d9', border:'#30363d',
        sidebarStyle:'solid', sidebarGrad1:'#161b22', sidebarGrad2:'#1c2333'
      };

      // Load gallery and personalUI from server
      const serverGallery = data.user.gallery && Object.keys(data.user.gallery).length > 0
        ? { ...defaultGallery, ...data.user.gallery }
        : defaultGallery;
      const serverUI = data.user.personal_ui && Object.keys(data.user.personal_ui).length > 0
        ? { ...defaultUI, ...data.user.personal_ui }
        : defaultUI;

      S.me = {
        id: data.user.id,
        name: data.user.display_name || data.user.username,
        color: data.user.color,
        accent: data.user.accent,
        bio: data.user.bio,
        avatar: data.user.avatar,
        banner: data.user.banner,
        gallery: serverGallery
      };
      S.personalUI = serverUI;

      await loadUserData();
      await loadDMsFromDatabase();
      ensureGalleryDefaults();

      document.getElementById('login-screen').style.display = 'none';
      renderAll();
      initWebSocket();

    } else {
      // REGISTER
      if (password !== passwordConfirm) {
        showLoginError('Passwords do not match');
        return;
      }

      const data = await api('/auth/register', {
        method: 'POST',
        body: { username, password }
      });

      setToken(data.token);

      const defaultGallery = {
        items:[], bg:'', bgColor:'#0d1117', surface:'#161b22',
        acc1:'#58a6ff', acc2:'#3fb950', text:'#c9d1d9', border:'#30363d'
      };

      S.me = {
        id: data.user.id,
        name: data.user.display_name || data.user.username,
        color: data.user.color,
        accent: data.user.accent,
        bio: data.user.bio,
        avatar: data.user.avatar,
        banner: data.user.banner,
        gallery: defaultGallery
      };

      showLoginSuccess('Account created!');
      ensureGalleryDefaults();

      setTimeout(() => {
        document.getElementById('login-screen').style.display = 'none';
        renderAll();
        initWebSocket();
      }, 1000);
    }
  } catch (err) {
    showLoginError(err.message);
  }
}

function loginUser(username, userData) {
  S.me.name = username;
  if (!S.me.bio) S.me.bio = "Hey, I'm " + username;

  document.getElementById('login-screen').style.display = 'none';
  renderAll();

  const c = ch();
  if (c && c.msgs.length === 0) {
    c.msgs.unshift({
      id: Date.now() - 9999,
      uid: '__sys__',
      text: `Welcome ${username}! üéâ Click + to create a server. Right-click channels to edit/delete. Right-click messages for options. Click avatars for profiles. Press Ctrl+F to search messages.`,
      sys: true,
      time: T()
    });
    renderMsgs();
  }

  autoSave();
}

/* ‚îÄ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-logout').onclick = () => {
  if(!confirm('Log out? Your data will be saved.')) return;

  // Save current state first
  saveState();

  // Disconnect WebSocket
  if (ws) {
    ws.close();
    ws = null;
  }

  // Clear the logged-in user's name (but keep their data)
  S.me.name = '';

  // Show login screen
  document.getElementById('login-screen').style.display = 'flex';

  // Clear the input fields
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-password-confirm').value = '';
  hideLoginMessages();

  // Reset to login tab
  isLoginMode = true;
  document.getElementById('tab-login').classList.add('active');
  document.getElementById('tab-register').classList.remove('active');
  document.getElementById('login-password-confirm').style.display = 'none';
  document.getElementById('login-btn').textContent = 'Login';
};

/* ‚îÄ‚îÄ‚îÄ GALLERY ‚îÄ‚îÄ‚îÄ */
async function openGallery(uid){
  // Parse string IDs to numbers
  if (uid !== 'me' && !isNaN(uid)) uid = Number(uid);

  S.currentGalleryUserId = uid;

  let u;
  if (uid === 'me') {
    u = S.me;
  } else if (typeof uid === 'number') {
    u = await fetchFullUser(uid);
  } else {
    u = U(uid);
  }

  // Ensure gallery defaults
  const defaultGal = { items:[], bg:'', bgColor:'#0d1117', surface:'#161b22', acc1:'#58a6ff', acc2:'#3fb950', text:'#c9d1d9', border:'#30363d' };
  if (!u.gallery) u.gallery = defaultGal;
  u.gallery = { ...defaultGal, ...u.gallery };
  const gal = u.gallery;

  // Apply gallery theme
  applyGalleryTheme(gal);

  // Set page background
  const bgLayer = document.getElementById('gallery-bg');
  if(gal.bg) {
    bgLayer.style.backgroundImage = `url(${gal.bg})`;
    bgLayer.classList.add('has-img');
  } else {
    bgLayer.style.backgroundImage = 'none';
    bgLayer.style.backgroundColor = gal.bgColor;
    bgLayer.classList.remove('has-img');
  }

  // Set title
  document.getElementById('gallery-owner-name').textContent = `${u.name}'s Gallery`;

  // Hide settings button if not owner
  const settingsBtn = document.getElementById('btn-gallery-settings');
  settingsBtn.style.display = uid === 'me' ? 'block' : 'none';
  document.getElementById('gallery-controls').style.display = uid === 'me' ? 'flex' : 'none';

  renderGallery();
  document.getElementById('gallery-page').classList.add('show');
}

function applyGalleryTheme(gal){
  const page = document.getElementById('gallery-page');
  page.style.setProperty('--gal-bg', gal.bgColor);
  page.style.setProperty('--gal-surface', gal.surface);
  page.style.setProperty('--gal-acc1', gal.acc1);
  page.style.setProperty('--gal-acc2', gal.acc2);
  page.style.setProperty('--gal-text', gal.text || '#c9d1d9');
  page.style.setProperty('--gal-border', gal.border || '#30363d');

  // Apply to gallery elements
  document.getElementById('gallery-header').style.background = `rgba(${hexToRgb(gal.surface)},0.92)`;
  document.getElementById('gallery-header').style.borderColor = gal.border || '#30363d';
  document.getElementById('gallery-header').style.color = gal.text || '#c9d1d9';
  document.getElementById('gallery-controls').style.background = `rgba(${hexToRgb(gal.surface)},0.92)`;
  document.getElementById('gallery-controls').style.borderColor = gal.border || '#30363d';

  // Update button gradients
  const gradBtns = document.querySelectorAll('#gallery-page .btn.grad, #gallery-controls .btn.grad');
  gradBtns.forEach(btn => {
    btn.style.background = `linear-gradient(135deg,${gal.acc1},${gal.acc2})`;
  });
}



function hexToRgb(hex){
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

function renderGallery(){
  const u = U(S.currentGalleryUserId);
  const grid = document.getElementById('gallery-grid');
  const empty = document.getElementById('gallery-empty');
  const gal = u.gallery;

  // Style gallery items with theme
  const itemBorder = gal.border || '#30363d';
  const itemBg = gal.surface;

  if(!u.gallery.items || u.gallery.items.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    empty.style.color = gal.text || '#c9d1d9';
    return;
  }

  empty.style.display = 'none';
  grid.innerHTML = '';

  u.gallery.items.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.style.background = itemBg;
    div.style.borderColor = itemBorder;

    if(item.type === 'video') {
      div.innerHTML = `
        <video src="${item.src}" controls></video>
        ${S.currentGalleryUserId === 'me' ? `<button class="gallery-item-del" data-idx="${idx}">‚úï</button>` : ''}
      `;
    } else {
      div.innerHTML = `
        <img src="${item.src}" alt="">
        ${S.currentGalleryUserId === 'me' ? `<button class="gallery-item-del" data-idx="${idx}">‚úï</button>` : ''}
      `;
    }

    grid.appendChild(div);
  });

  // Wire delete buttons
  grid.querySelectorAll('.gallery-item-del').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      deleteGalleryItem(Number(btn.dataset.idx));
    };
  });
}

function deleteGalleryItem(idx){
  if(!confirm('Delete this item?')) return;
  const u = U(S.currentGalleryUserId);
  u.gallery.items.splice(idx, 1);
  renderGallery();
  autoSave();
  syncSettingsToServer();
}

document.getElementById('btn-close-gallery').onclick = () => {
  document.getElementById('gallery-page').classList.remove('show');
  S.currentGalleryUserId = null;
  // Restore theme
  renderAll();
};

document.getElementById('btn-gallery-upload').onclick = () => {
  document.getElementById('gallery-upload').click();
};

document.getElementById('gallery-upload').onchange = async (e) => {
  const files = Array.from(e.target.files);
  if(files.length === 0) return;

  const u = U('me');

  for(const file of files) {
    const src = await readF(file);
    const type = file.type.startsWith('video/') ? 'video' : 'image';
    u.gallery.items.push({ src, type });
  }

  e.target.value = '';
  renderGallery();
  autoSave();
  syncSettingsToServer();
};

// Gallery Settings
document.getElementById('btn-gallery-settings').onclick = () => {
  const u = U('me');
  const gal = u.gallery;

  // Page background
  document.getElementById('gal-bg').value = gal.bgColor;
  document.getElementById('gal-surf').value = gal.surface;
  setPreview('ub-gallery-bg', gal.bg || '');

  // Accents
  document.getElementById('gal-acc1').value = gal.acc1;
  document.getElementById('gal-acc2').value = gal.acc2;
  document.getElementById('gal-grad-swatch').style.background = `linear-gradient(135deg,${gal.acc1},${gal.acc2})`;

  // Other colors
  document.getElementById('gal-text').value = gal.text || '#c9d1d9';
  document.getElementById('gal-border').value = gal.border || '#30363d';

  openM('m-gallery-settings');
};


// Live preview for gallery settings
['gal-bg','gal-surf','gal-acc1','gal-acc2','gal-text','gal-border'].forEach(id => {
  const el = document.getElementById(id);
  if(el) {
    el.addEventListener('input', updateGalleryPreview);
  }
});

function updateGalleryPreview(){
  const gal = U('me').gallery;

  gal.bgColor = document.getElementById('gal-bg').value;
  gal.surface = document.getElementById('gal-surf').value;
  gal.acc1 = document.getElementById('gal-acc1').value;
  gal.acc2 = document.getElementById('gal-acc2').value;
  gal.text = document.getElementById('gal-text').value;
  gal.border = document.getElementById('gal-border').value;

  // Update swatches
  document.getElementById('gal-grad-swatch').style.background = `linear-gradient(135deg,${gal.acc1},${gal.acc2})`;

  // Apply live
  applyGalleryTheme(gal);
  renderGallery();

  // Update page bg color if no image
  if(!gal.bg) {
    document.getElementById('gallery-bg').style.backgroundColor = gal.bgColor;
  }
}

document.getElementById('btn-save-gallery-settings').onclick = async () => {
  const u = U('me');
  const gal = u.gallery;

  // Save page background image
  const bgFile = document.getElementById('ub-gallery-bg').querySelector('input').files[0];
  if(bgFile) gal.bg = await readF(bgFile);

  closeM('m-gallery-settings');
  openGallery('me');
  autoSave();
  syncSettingsToServer();
};

document.getElementById('btn-reset-gallery-settings').onclick = () => {
  const u = U('me');
  u.gallery = {
    items: u.gallery.items,
    bg: '',
    bgColor: '#0d1117',
    surface: '#161b22',
    acc1: '#58a6ff',
    acc2: '#3fb950',
    text: '#c9d1d9',
    border: '#30363d'
  };
  closeM('m-gallery-settings');
  openGallery('me');
  autoSave();
  syncSettingsToServer();
};

// ============================================
// WEBSOCKET CLIENT CODE
// ============================================

// WebSocket connection
let ws = null;
let wsReconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

// Initialize WebSocket connection
function initWebSocket() {
    const token = getToken();
    if (!token) {
        console.log('No token found, cannot connect to WebSocket');
        return;
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}`;

    console.log('Connecting to WebSocket:', wsUrl);

    ws = new WebSocket(wsUrl);

    ws.addEventListener('open', () => {
        console.log('WebSocket connected!');
        wsReconnectAttempts = 0;

        ws.send(JSON.stringify({
            type: 'authenticate',
            token: token
        }));
    });

    ws.addEventListener('message', (event) => {
        try {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data.type);

            switch (data.type) {
                case 'authenticated':
                    console.log('WebSocket authenticated as user:', data.username);
                    break;

                case 'channel_message':
                    handleNewChannelMessage(data.channelId, data.message);
                    break;

                case 'dm_message':
                    handleNewDMMessage(data.dmChannelId, data.message);
                    break;

                case 'message_edited':
                    handleMessageEdited(data.channelId, data.messageId, data.text, false);
                    break;

                case 'dm_message_edited':
                    handleMessageEdited(data.dmChannelId, data.messageId, data.text, true);
                    break;

                case 'message_deleted':
                    handleMessageDeleted(data.channelId, data.messageId, false);
                    break;

                case 'dm_message_deleted':
                    handleMessageDeleted(data.dmChannelId, data.messageId, true);
                    break;

                case 'user_typing':
                    handleTypingIndicator(data);
                    break;

                    case 'profile_updated':
                    upsertUser({
                      id: data.user.id,
                      name: data.user.display_name || data.user.username,
                      color: data.user.color,
                      accent: data.user.accent,
                      avatar: data.user.avatar,
                      banner: data.user.banner,
                      bio: data.user.bio
                    });
                    // Re-render to show updated profile everywhere
                    lastRenderedChId = null;
                    renderMsgs();
                    renderSidebar();
                    break;

                case 'error':
                    console.error('WebSocket error:', data.message);
                    break;

                case 'friend_request_received':
                case 'friend_request_sent':
                case 'friend_request_accepted':
                case 'friend_request_declined':
                    updateFriendBadge();
                    break;

                case 'dm_bg_changed': {
                    const homeServer = S.servers.find(s => s.id === 'home');
                    if (homeServer) {
                        const dm = homeServer.dms.find(d => d.id === data.dmChannelId);
                        if (dm) {
                            dm.bg = data.background || '';
                            const c = ch();
                            if (c && c.id === data.dmChannelId) renderBg();
                        }
                    }
                    break;
                }

                case 'channel_bg_changed': {
                    for (const s of S.servers) {
                        if (!s.channels) continue;
                        const chan = s.channels.find(c => c.id === data.channelId);
                        if (chan) {
                            chan.bg = data.background || '';
                            const c = ch();
                            if (c && c.id === data.channelId) renderBg();
                            break;
                        }
                    }
                    break;
                }

                case 'server_aesthetics_updated': {
                    const s = S.servers.find(sv => sv.id === data.serverId);
                    if (s) {
                        if (data.aesthetics) s.aesthetics = data.aesthetics;
                        if (data.name) s.name = data.name;
                        if (data.iconImg !== undefined) s.iconImg = data.iconImg;
                        if (data.banner !== undefined) s.banner = data.banner;
                        if (data.defChBg !== undefined) s.defChBg = data.defChBg;
                        // Re-render if viewing this server (respects personal override)
                        if (S.srvId === data.serverId) {
                            renderAll();
                        } else {
                            renderRail();
                        }
                    }
                    break;
                }
            }
        } catch (err) {
            console.error('Error parsing WebSocket message:', err);
        }
    });

    ws.addEventListener('close', () => {
        console.log('WebSocket disconnected');
        ws = null;

        if (wsReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
            wsReconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000);
            console.log(`Reconnecting in ${delay}ms... (attempt ${wsReconnectAttempts})`);
            setTimeout(initWebSocket, delay);
        }
    });

    ws.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
    });
}

function sendMessageViaWebSocket(channelId, text, image = null, reply_to = null, isDM = false, dmChannelId = null) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not connected');
        return sendMessageViaHTTP(channelId, text, image, reply_to, isDM, dmChannelId);
    }

    ws.send(JSON.stringify({
        type: 'new_message',
        channelId: channelId,
        dmChannelId: dmChannelId,
        text: text,
        image: image,
        reply_to: reply_to,
        isDM: isDM
    }));
}

function editMessageViaWebSocket(messageId, text, isDM, channelId, dmChannelId) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not connected');
        return;
    }

    ws.send(JSON.stringify({
        type: 'edit_message',
        messageId: messageId,
        text: text,
        isDM: isDM,
        channelId: channelId,
        dmChannelId: dmChannelId
    }));
}

function deleteMessageViaWebSocket(messageId, isDM, channelId, dmChannelId) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not connected');
        return;
    }

    ws.send(JSON.stringify({
        type: 'delete_message',
        messageId: messageId,
        isDM: isDM,
        channelId: channelId,
        dmChannelId: dmChannelId
    }));
}

function sendTypingIndicator(channelId, isDM, dmChannelId) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        return;
    }

    ws.send(JSON.stringify({
        type: 'typing',
        channelId: channelId,
        isDM: isDM,
        dmChannelId: dmChannelId
    }));
}

function handleNewChannelMessage(channelId, message) {
  // Add/update sender with latest data
    upsertUser({
      id: message.user_id,
      name: message.display_name || message.username,
      color: message.color,
      accent: message.accent,
      avatar: message.avatar
    });

    const c = ch();
    if (!c || c.id !== channelId) return;

  c.msgs.push({
        id: message.id,
        uid: message.user_id === S.me.id ? 'me' : message.user_id,
        text: message.text || '',
        img: message.image || null,
        reply: message.reply_to,
        time: new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
        edited: message.edited,
        reactions: message.reactions || {},
        username: message.username,
        userColor: message.color || '#58a6ff',
        sys: message.is_system || false
    });

    renderMsgs();
    autoSave();
}

function handleNewDMMessage(dmChannelId, message) {
  // Add/update sender with latest data
    upsertUser({
      id: message.user_id,
      name: message.display_name || message.username,
      color: message.color,
      accent: message.accent,
      avatar: message.avatar
    });

    const c = ch();
    if (!c || c.id !== dmChannelId) return;

  // Remove optimistic temp message if this is our own echo
    if (message.user_id === S.me.id) {
        const tempIdx = c.msgs.findIndex(m => m._temp && m.text === (message.text || ''));
        if (tempIdx > -1) c.msgs.splice(tempIdx, 1);
    }

    c.msgs.push({
        id: message.id,
        uid: message.user_id === S.me.id ? 'me' : message.user_id,
        text: message.text || '',
        img: message.image || null,
        reply: message.reply_to,
        time: new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
        edited: message.edited,
        reactions: message.reactions || {},
        username: message.username,
        userColor: message.color || '#58a6ff',
        sys: message.is_system || false
    });

    renderMsgs();
    autoSave();
}

function handleMessageEdited(channelOrDmId, messageId, newText, isDM) {
    const c = ch();
    if (!c) return;

    const message = c.msgs.find(m => m.id === messageId);
    if (message) {
        message.text = newText;
        message.edited = true;
        renderMsgs();
        autoSave();
    }
}

function handleMessageDeleted(channelOrDmId, messageId, isDM) {
    const c = ch();
    if (!c) return;

    const index = c.msgs.findIndex(m => m.id === messageId);
    if (index !== -1) {
        c.msgs.splice(index, 1);
        const row = document.querySelector(`.msg-row[data-id="${messageId}"]`);
        if (row) row.remove();
        autoSave();
    }
}

function handleTypingIndicator(data) {
    console.log(`${data.username} is typing...`);
}

async function sendMessageViaHTTP(channelId, text, image, reply_to, isDM, dmChannelId) {
    const token = getToken();
    const url = isDM
        ? `${API_URL}/dms/${dmChannelId}/messages`
        : `${API_URL}/channels/${channelId}/messages`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ text, image, reply_to })
        });

        if (!response.ok) {
            throw new Error('Failed to send message');
        }

        const message = await response.json();

        if (isDM) {
            handleNewDMMessage(dmChannelId, message);
        } else {
            handleNewChannelMessage(channelId, message);
        }
    } catch (error) {
        console.error('Error sending message via HTTP:', error);
        alert('Failed to send message');
    }
}

console.log('WebSocket client code loaded');

// ============================================
// USER SEARCH & FRIEND REQUESTS
// ============================================

let currentUserId = null;
const API = API_URL; // Use existing API_URL variable

// Load current user
(async function initUserSearch() {
    try {
        const res = await fetch(`${API}/me`, {
            headers: { Authorization: `Bearer ${getToken()}` }
        });
        if (res.ok) {
            const user = await res.json();
            currentUserId = user.id;
            console.log('Current user loaded:', currentUserId);
        }
    } catch (err) {
        console.error('Init user search error:', err);
    }
})();

// Close search modal
document.addEventListener('click', (e) => {
    if (e.target.id === 'user-search-close') {
        document.getElementById('user-search-overlay').classList.remove('show');
        document.getElementById('user-search-input').value = '';
        document.getElementById('user-search-results').innerHTML = '';
    }
    if (e.target.id === 'friend-requests-close') {
        document.getElementById('friend-requests-overlay').classList.remove('show');
    }
});

// Search as you type
let searchTimeout;
document.addEventListener('input', (e) => {
    if (e.target.id === 'user-search-input') {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length === 0) {
            document.getElementById('user-search-results').innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(() => searchUsers(query), 300);
    }
});

async function searchUsers(query) {
    try {
        console.log('üîç Searching for:', query);
        console.log('üì° API URL:', `${API}/users/search?q=${encodeURIComponent(query)}`);
        console.log('üîë Token:', getToken() ? 'Present' : 'MISSING');

        const res = await fetch(`${API}/users/search?q=${encodeURIComponent(query)}`, {
            headers: { Authorization: `Bearer ${getToken()}` }
        });

        console.log('üì® Response status:', res.status);

        if (!res.ok) {
            const errorData = await res.json();
            console.error('‚ùå API Error:', errorData);
            throw new Error(errorData.error || 'Search failed');
        }

        const users = await res.json();
        console.log('‚úÖ Found users:', users);
        await displaySearchResults(users);
    } catch (err) {
        console.error('üí• Search error:', err);
        document.getElementById('user-search-results').innerHTML =
            `<div class="search-empty">‚ùå Error: ${err.message}</div>`;
    }
}

// Display results
async function displaySearchResults(users) {
    const container = document.getElementById('user-search-results');

    if (users.length === 0) {
        container.innerHTML = '<div class="search-empty">No users found</div>';
        return;
    }

    container.innerHTML = '';

    for (const user of users) {
        try {
            const statusRes = await fetch(`${API}/friends/status/${user.id}`, {
                headers: { Authorization: `Bearer ${getToken()}` }
            });
            const statusData = await statusRes.json();

            const item = document.createElement('div');
            item.className = 'user-search-item';

            const avatar = user.avatar
                ? `<img src="${user.avatar}" alt="${user.username}">`
                : `<div style="color: ${user.color}">${user.username[0].toUpperCase()}</div>`;

            let actionButtons = '';

            if (statusData.status === 'none') {
                actionButtons = `<button class="user-search-btn primary" onclick="sendFriendRequest(${user.id}, this)">Add Friend</button>`;
            } else if (statusData.status === 'pending_sent') {
                actionButtons = `
                    <button class="user-search-btn secondary" disabled>Request Sent</button>
                    <button class="user-search-btn secondary" onclick="cancelFriendRequest(${statusData.requestId}, this)">Cancel</button>
                `;
            } else if (statusData.status === 'pending_received') {
                actionButtons = `
                    <button class="user-search-btn primary" onclick="acceptFriendRequest(${statusData.requestId}, this)">Accept</button>
                    <button class="user-search-btn secondary" onclick="declineFriendRequest(${statusData.requestId}, this)">Decline</button>
                `;
            } else if (statusData.status === 'accepted') {
                actionButtons = `<button class="user-search-btn primary" onclick="openDMWithUser(${user.id})">Message</button>`;
            }

            item.innerHTML = `
                <div class="user-search-avatar">${avatar}</div>
                <div class="user-search-info">
                    <div class="user-search-name" style="color: ${user.color}">
                        ${user.display_name || user.username}
                    </div>
                    <div class="user-search-username">@${user.username}</div>
                </div>
                <div class="user-search-actions">${actionButtons}</div>
            `;

            container.appendChild(item);
        } catch (err) {
            console.error('Error displaying user:', err);
        }
    }
}

// Send friend request
async function sendFriendRequest(friendId, button) {
    try {
        button.disabled = true;
        button.textContent = 'Sending...';

        const res = await fetch(`${API}/friends/request`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${getToken()}`
            },
            body: JSON.stringify({ friendId })
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Failed');
        }

        const request = await res.json();

        // Notify via WebSocket
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'friend_request_sent',
                targetUserId: friendId,
                requestId: request.id
            }));
        }

        // Refresh search results if search is open
        const searchInput = document.getElementById('user-search-input');
        if (searchInput && searchInput.value) {
          searchUsers(searchInput.value);
        }
        // Update badge
        updateFriendBadge();

    } catch (err) {
        console.error('Send request error:', err);
        alert(err.message);
        button.disabled = false;
        button.textContent = 'Add Friend';
    }
}

// Accept friend request
async function acceptFriendRequest(requestId, button) {
    try {
        button.disabled = true;

        const res = await fetch(`${API}/friends/request/${requestId}/accept`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${getToken()}`
            }
        });

        if (!res.ok) throw new Error('Failed to accept');

        // Notify sender
        const requestsRes = await fetch(`${API}/friends/requests`, {
            headers: { Authorization: `Bearer ${getToken()}` }
        });
        const requests = await requestsRes.json();
        const request = requests.find(r => r.id === requestId);

        if (request && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'friend_request_accepted',
                targetUserId: request.user_id,
                requestId: requestId
            }));
        }

        // Refresh search results if search is open
        const searchInput = document.getElementById('user-search-input');
        if (searchInput && searchInput.value) searchUsers(searchInput.value);
        updateFriendBadge();

    } catch (err) {
        console.error('Accept error:', err);
        alert('Failed to accept');
        button.disabled = false;
    }
}

// Decline/Cancel request
async function declineFriendRequest(requestId, button) {
    try {
        button.disabled = true;

        const res = await fetch(`${API}/friends/request/${requestId}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${getToken()}` }
        });

        if (!res.ok) throw new Error('Failed');

        // Refresh search results if search is open
        const searchInput = document.getElementById('user-search-input');
        if (searchInput && searchInput.value) searchUsers(searchInput.value);
        updateFriendBadge();

    } catch (err) {
        console.error('Decline error:', err);
        alert('Failed to decline');
        button.disabled = false;
    }
}

/* ‚îÄ‚îÄ‚îÄ FRIENDS MODAL ‚îÄ‚îÄ‚îÄ */
document.getElementById('btn-friends').onclick = () => {
  openM('m-friends');
  switchFriendsTab('list');
  loadFriendsList();
};

document.getElementById('tab-friends-list').onclick = () => switchFriendsTab('list');
document.getElementById('tab-friends-requests').onclick = () => switchFriendsTab('requests');

function switchFriendsTab(tab) {
  const listTab = document.getElementById('tab-friends-list');
  const reqTab = document.getElementById('tab-friends-requests');
  const listPanel = document.getElementById('friends-list-panel');
  const reqPanel = document.getElementById('friends-requests-panel');

  if (tab === 'list') {
    listTab.style.color = 'var(--text)';
    listTab.style.borderBottomColor = 'var(--accent)';
    reqTab.style.color = 'var(--dim)';
    reqTab.style.borderBottomColor = 'transparent';
    listPanel.style.display = 'block';
    reqPanel.style.display = 'none';
    loadFriendsList();
  } else {
    reqTab.style.color = 'var(--text)';
    reqTab.style.borderBottomColor = 'var(--accent)';
    listTab.style.color = 'var(--dim)';
    listTab.style.borderBottomColor = 'transparent';
    listPanel.style.display = 'none';
    reqPanel.style.display = 'block';
    loadFriendRequests();
  }
}

async function loadFriendsList() {
  const panel = document.getElementById('friends-list-panel');
  panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--dim)">Loading...</div>';
  try {
    const all = await api('/friends');
    const friends = all.filter(f => f.status === 'accepted');
    if (friends.length === 0) {
      panel.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--dim);font-size:13px"><div style="font-size:36px;margin-bottom:8px;opacity:0.3">üë•</div>No friends yet<br><span style="font-size:12px;opacity:0.7">Search for users to add friends</span></div>';
      return;
    }
    panel.innerHTML = '';
    friends.forEach(f => {
      const u = f.user;
      const avInner = u.avatar
        ? `<img src="${u.avatar}" style="width:38px;height:38px;border-radius:50%;object-fit:cover">`
        : `<div style="width:38px;height:38px;border-radius:50%;background:${u.color || '#58a6ff'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:700">‚ú¶</div>`;

      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:background .15s';
      row.onmouseenter = () => row.style.background = 'var(--surface2)';
      row.onmouseleave = () => row.style.background = '';
      row.innerHTML = `
        ${avInner}
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:14px;color:${u.color || '#58a6ff'};overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.display_name || u.username}</div>
          <div style="font-size:12px;color:var(--dim)">@${u.username}</div>
        </div>
        <button class="btn sec" style="font-size:12px;padding:6px 12px" data-dm-uid="${u.id}">üí¨ DM</button>
      `;
      row.querySelector('[data-dm-uid]').onclick = async (e) => {
        e.stopPropagation();
        try {
          const dm = await api('/dms', { method:'POST', body:{ userId: u.id } });
          await loadDMsFromDatabase();
          S.view = 'dms'; S.srvId = 'home'; S.chId = dm.id;
          closeM('m-friends');
          renderAll();
        } catch(err) { console.error('DM open failed:', err); }
      };
      row.onclick = (e) => showPC(e, u.id);
      panel.appendChild(row);
    });
  } catch(err) {
    panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Failed to load friends</div>';
    console.error(err);
  }
}

async function loadFriendRequests() {
  const panel = document.getElementById('friends-requests-panel');
  panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--dim)">Loading...</div>';
  try {
    const all = await api('/friends/requests');
    const requests = all.filter(f => f.status === 'pending' && !f.isRequester);
    const sent = all.filter(f => f.status === 'pending' && f.isRequester);

    // Update badge
    const badge = document.getElementById('req-count-badge');
    if (requests.length > 0) {
      badge.textContent = requests.length;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }

    if (requests.length === 0 && sent.length === 0) {
      panel.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--dim);font-size:13px"><div style="font-size:36px;margin-bottom:8px;opacity:0.3">üì≠</div>No pending requests</div>';
      return;
    }

    panel.innerHTML = '';

    if (requests.length > 0) {
      const label = document.createElement('div');
      label.style.cssText = 'font-size:11px;font-weight:600;color:var(--dim);padding:4px 12px 8px;text-transform:uppercase;letter-spacing:0.5px';
      label.textContent = `Incoming ‚Äî ${requests.length}`;
      panel.appendChild(label);

      requests.forEach(r => {
        const u = r.user;
        const avInner = u.avatar
          ? `<img src="${u.avatar}" style="width:38px;height:38px;border-radius:50%;object-fit:cover">`
          : `<div style="width:38px;height:38px;border-radius:50%;background:${u.color || '#58a6ff'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:700">‚ú¶</div>`;

        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px';
        row.innerHTML = `
          ${avInner}
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;font-size:14px;color:${u.color || '#58a6ff'}">${u.display_name || u.username}</div>
            <div style="font-size:12px;color:var(--dim)">@${u.username}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn pri" style="font-size:12px;padding:6px 12px" data-accept="${r.id}">‚úì Accept</button>
            <button class="btn dan" style="font-size:12px;padding:6px 12px" data-decline="${r.id}">‚úï</button>
          </div>
        `;
        row.querySelector('[data-accept]').onclick = async (e) => {
          await acceptFriendRequest(r.id, e.target);
          loadFriendRequests();
        };
        row.querySelector('[data-decline]').onclick = async (e) => {
          await declineFriendRequest(r.id, e.target);
          loadFriendRequests();
        };
        panel.appendChild(row);
      });
    }

    if (sent.length > 0) {
      const label = document.createElement('div');
      label.style.cssText = 'font-size:11px;font-weight:600;color:var(--dim);padding:12px 12px 8px;text-transform:uppercase;letter-spacing:0.5px';
      label.textContent = `Sent ‚Äî ${sent.length}`;
      panel.appendChild(label);

      sent.forEach(r => {
        const u = r.user;
        const avInner = u.avatar
          ? `<img src="${u.avatar}" style="width:38px;height:38px;border-radius:50%;object-fit:cover">`
          : `<div style="width:38px;height:38px;border-radius:50%;background:${u.color || '#58a6ff'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:700">‚ú¶</div>`;

        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;opacity:0.7';
        row.innerHTML = `
          ${avInner}
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;font-size:14px;color:${u.color || '#58a6ff'}">${u.display_name || u.username}</div>
            <div style="font-size:12px;color:var(--dim)">@${u.username}</div>
          </div>
          <span style="font-size:12px;color:var(--dim)">‚è≥ Pending</span>
        `;
        panel.appendChild(row);
      });
    }
  } catch(err) {
    panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Failed to load requests</div>';
    console.error(err);
  }
}

// Cancel (same as decline)
async function cancelFriendRequest(requestId, button) {
    await declineFriendRequest(requestId, button);
}

/* ‚îÄ‚îÄ‚îÄ FRIEND REQUEST BADGE ‚îÄ‚îÄ‚îÄ */
async function updateFriendBadge() {
  try {
    if (!getToken()) return;
    const all = await api('/friends/requests');
    const incoming = all.filter(f => f.status === 'pending' && !f.isRequester);
    const badge = document.getElementById('friends-notif-badge');
    const modalBadge = document.getElementById('req-count-badge');
    if (incoming.length > 0) {
      const label = incoming.length > 10 ? '10+' : String(incoming.length);
      badge.textContent = label;
      badge.style.display = 'flex';
      if (modalBadge) { modalBadge.textContent = label; modalBadge.style.display = 'inline'; }
    } else {
      badge.style.display = 'none';
      if (modalBadge) modalBadge.style.display = 'none';
    }
  } catch(e) { /* silent */ }
}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR RESIZE ‚îÄ‚îÄ‚îÄ */
(function() {
  const handle = document.getElementById('sidebar-resize-handle');
  const layout = document.getElementById('layout');
  let dragging = false, startX, startW;
  const MIN_W = 120, MAX_W = 360;

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    dragging = true;
    startX = e.clientX;
    const computed = getComputedStyle(layout);
    const cols = computed.gridTemplateColumns.split(/\s+/);
    startW = parseFloat(cols[1]) || 240;
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const delta = e.clientX - startX;
    const newW = Math.min(MAX_W, Math.max(MIN_W, startW + delta));
    layout.style.setProperty('--sidebar-w', newW + 'px');
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// Open DM
async function openDMWithUser(userId) {
    try {
        const res = await fetch(`${API}/dms`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${getToken()}`
            },
            body: JSON.stringify({ otherUserId: userId })
        });

        if (!res.ok) throw new Error('Failed to create DM');

        const dmChannel = await res.json();

        // Close search
        document.getElementById('user-search-overlay').classList.remove('show');

        // Reload DMs and navigate to the new DM
        await loadDMsFromDatabase();

        // Switch to home/DMs view
        S.srvId = 'home';
        S.view = 'dms';
        S.chId = dmChannel.id;

        renderAll();

        console.log('DM Channel opened:', dmChannel);

    } catch (err) {
        console.error('Open DM error:', err);
        alert('Failed to open DM');
    }
}
</script>
</body>
</html>

